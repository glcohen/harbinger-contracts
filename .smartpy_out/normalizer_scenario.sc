[{"shortname": "Fails_with_bad_contract_data", "longname": "Fails with bad contract data", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails when data is pushed from bad address", "line_no": 159}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract whitelisted to an address", "line_no": 161}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63) (literal (string \"BTC-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 165) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 165) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 165) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"BTC-USD\") 165) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 165) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 165) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 1089)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_139\" (first (params 137) 139) 139) (defineLocal \"compute_140\" (second (params 137) 140) 140) (verify (contains (attr (data) \"assetMap\" 144) (getLocal \"compute_139\" 139) 144) False (literal (string \"bad request\") 143) 143) (set (operations 150) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 144) (getLocal \"compute_139\" 139) 149) \"computedPrice\" 149) (literal (mutez 0) 150) (getLocal \"compute_140\" 140) 150) (operations 150) 150) 150))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (ifBlock (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) ((set (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 99) \"lastUpdateTime\" 99) (getLocal \"compute_96\" 96) 99) (defineLocal \"compute_102\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 102) 102) (defineLocal \"compute_103\" (second (getLocal \"compute_102\" 102) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_110\" (first (getLocal \"compute_104\" 104) 110) 110) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (second (getLocal \"compute_106\" 106) 113) 113) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"last\" 117) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"last\" 117) (literal (intOrNat 1) 117) 117) 117) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"sum\" 117) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"sum\" 117) (mul (truediv (add (add (getLocal \"compute_110\" 110) (getLocal \"compute_111\" 111) 114) (getLocal \"compute_112\" 112) 114) (literal (intOrNat 3) 114) 114) (getLocal \"compute_113\" 113) 114) 117) 117) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"saved\" 117) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"last\" 117) 117) (mul (truediv (add (add (getLocal \"compute_110\" 110) (getLocal \"compute_111\" 111) 114) (getLocal \"compute_112\" 112) 114) (literal (intOrNat 3) 114) 114) (getLocal \"compute_113\" 113) 114) 117) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"sum\" 118) (getLocal \"compute_113\" 113) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"last\" 118) 118) (getLocal \"compute_113\" 113) 118) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 121) \"prices\" 121) \"last\" 121) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 121) \"prices\" 121) \"first\" 121) 121) (literal (intOrNat 1) 121) 121) (attr (data) \"numDataPoints\" 121) 121) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) 122) False 122) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"sum\" 122) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"sum\" 122) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"saved\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) 122) 122) \"Some\" 122) 122) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"saved\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) (literal (intOrNat 1) 122) 122) 122) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123)) 121) (set (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 126) \"computedPrice\" 126) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 126) \"prices\" 126) \"sum\" 126) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 126) \"volumes\" 126) \"sum\" 126) 126) 126)) 97)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 165, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN an update is pushed from the wrong address", "line_no": 167}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": 168}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 1098 ((literal (string \"XTZ-USD\") 170) (tuple (literal (timestamp 1595104501) 173) (tuple (literal (timestamp 1595104531) 174) (tuple (literal (intOrNat 3059701) 170) (tuple (literal (intOrNat 1) 170) (tuple (literal (intOrNat 2) 170) (tuple (literal (intOrNat 3) 170) (literal (intOrNat 4) 170) 170) 170) 170) 170) 170) 170))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 1098)", "line_no": 170, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1FrRkunqmB7futF3EyRwTt8f7fPEVJW39P\") 169)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Fails_with_updates_from_the_same_time", "longname": "Fails with updates from the same time", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails with updates from the past", "line_no": 186}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract with an update at a given time = 1", "line_no": 188}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63) (literal (string \"BTC-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 192) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 192) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 192) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"BTC-USD\") 192) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 192) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 192) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_139\" (first (params 137) 139) 139) (defineLocal \"compute_140\" (second (params 137) 140) 140) (verify (contains (attr (data) \"assetMap\" 144) (getLocal \"compute_139\" 139) 144) False (literal (string \"bad request\") 143) 143) (set (operations 150) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 144) (getLocal \"compute_139\" 139) 149) \"computedPrice\" 149) (literal (mutez 0) 150) (getLocal \"compute_140\" 140) 150) (operations 150) 150) 150))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (ifBlock (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) ((set (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 99) \"lastUpdateTime\" 99) (getLocal \"compute_96\" 96) 99) (defineLocal \"compute_102\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 102) 102) (defineLocal \"compute_103\" (second (getLocal \"compute_102\" 102) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_110\" (first (getLocal \"compute_104\" 104) 110) 110) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (second (getLocal \"compute_106\" 106) 113) 113) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"last\" 117) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"last\" 117) (literal (intOrNat 1) 117) 117) 117) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"sum\" 117) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"sum\" 117) (mul (truediv (add (add (getLocal \"compute_110\" 110) (getLocal \"compute_111\" 111) 114) (getLocal \"compute_112\" 112) 114) (literal (intOrNat 3) 114) 114) (getLocal \"compute_113\" 113) 114) 117) 117) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"saved\" 117) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"last\" 117) 117) (mul (truediv (add (add (getLocal \"compute_110\" 110) (getLocal \"compute_111\" 111) 114) (getLocal \"compute_112\" 112) 114) (literal (intOrNat 3) 114) 114) (getLocal \"compute_113\" 113) 114) 117) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"sum\" 118) (getLocal \"compute_113\" 113) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"last\" 118) 118) (getLocal \"compute_113\" 113) 118) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 121) \"prices\" 121) \"last\" 121) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 121) \"prices\" 121) \"first\" 121) 121) (literal (intOrNat 1) 121) 121) (attr (data) \"numDataPoints\" 121) 121) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) 122) False 122) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"sum\" 122) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"sum\" 122) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"saved\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) 122) 122) \"Some\" 122) 122) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"saved\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) (literal (intOrNat 1) 122) 122) 122) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123)) 121) (set (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 126) \"computedPrice\" 126) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 126) \"prices\" 126) \"sum\" 126) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 126) \"volumes\" 126) \"sum\" 126) 126) 126)) 97)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 192, "show": true, "accept_unknown_types": false}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 1098 ((literal (string \"XTZ-USD\") 202) (tuple (literal (timestamp 1) 194) (tuple (literal (timestamp 2) 195) (tuple (literal (intOrNat 1) 202) (tuple (literal (intOrNat 2) 202) (tuple (literal (intOrNat 3) 202) (tuple (literal (intOrNat 4) 202) (literal (intOrNat 5) 202) 202) 202) 202) 202) 202) 202))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 1098)", "line_no": 202, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 1089)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided at the same time.", "line_no": 215}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 1098 ((literal (string \"XTZ-USD\") 222) (tuple (literal (timestamp 1) 194) (tuple (literal (timestamp 2) 195) (tuple (literal (intOrNat 6) 222) (tuple (literal (intOrNat 7) 222) (tuple (literal (intOrNat 8) 222) (tuple (literal (intOrNat 9) 222) (literal (intOrNat 10) 222) 222) 222) 222) 222) 222) 222))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 1098)", "line_no": 222, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 1089)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the original time is still reported.", "line_no": 235}, {"action": "verify", "condition": "(eq (attr (getItem (attr (contractData 0 222) \"assetMap\" 242) (literal (string \"XTZ-USD\") 242) 242) \"computedPrice\" 242) (literal (intOrNat 3) 242) 242)", "line_no": 242}]}, {"shortname": "Fails_with_updates_from_the_past_time", "longname": "Fails with updates from the past time", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails with updates from the past", "line_no": 247}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract with an update at a current time and a time in the past", "line_no": 249}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63) (literal (string \"BTC-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 255) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 255) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 255) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"BTC-USD\") 255) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 255) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 255) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_139\" (first (params 137) 139) 139) (defineLocal \"compute_140\" (second (params 137) 140) 140) (verify (contains (attr (data) \"assetMap\" 144) (getLocal \"compute_139\" 139) 144) False (literal (string \"bad request\") 143) 143) (set (operations 150) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 144) (getLocal \"compute_139\" 139) 149) \"computedPrice\" 149) (literal (mutez 0) 150) (getLocal \"compute_140\" 140) 150) (operations 150) 150) 150))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (ifBlock (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) ((set (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 99) \"lastUpdateTime\" 99) (getLocal \"compute_96\" 96) 99) (defineLocal \"compute_102\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 102) 102) (defineLocal \"compute_103\" (second (getLocal \"compute_102\" 102) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_110\" (first (getLocal \"compute_104\" 104) 110) 110) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (second (getLocal \"compute_106\" 106) 113) 113) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"last\" 117) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"last\" 117) (literal (intOrNat 1) 117) 117) 117) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"sum\" 117) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"sum\" 117) (mul (truediv (add (add (getLocal \"compute_110\" 110) (getLocal \"compute_111\" 111) 114) (getLocal \"compute_112\" 112) 114) (literal (intOrNat 3) 114) 114) (getLocal \"compute_113\" 113) 114) 117) 117) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"saved\" 117) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 117) \"prices\" 117) \"last\" 117) 117) (mul (truediv (add (add (getLocal \"compute_110\" 110) (getLocal \"compute_111\" 111) 114) (getLocal \"compute_112\" 112) 114) (literal (intOrNat 3) 114) 114) (getLocal \"compute_113\" 113) 114) 117) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"sum\" 118) (getLocal \"compute_113\" 113) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 118) \"volumes\" 118) \"last\" 118) 118) (getLocal \"compute_113\" 113) 118) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 121) \"prices\" 121) \"last\" 121) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 121) \"prices\" 121) \"first\" 121) 121) (literal (intOrNat 1) 121) 121) (attr (data) \"numDataPoints\" 121) 121) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) 122) False 122) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"sum\" 122) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"sum\" 122) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"saved\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) 122) 122) \"Some\" 122) 122) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"saved\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) (literal (intOrNat 1) 122) 122) 122) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 123) \"volumes\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123)) 121) (set (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 126) \"computedPrice\" 126) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 126) \"prices\" 126) \"sum\" 126) (attr (attr (getItem (attr (data) \"assetMap\" 144) (iter \"assetCode\" 90) 126) \"volumes\" 126) \"sum\" 126) 126) 126)) 97)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 255, "show": true, "accept_unknown_types": false}, {"action": "error", "message": "name 'assetCode' is not defined"}]}, {"shortname": "Normalizes_stale_assets_correctly", "longname": "Normalizes stale assets correctly", "scenario": [{"action": "error", "message": "list index out of range"}]}, {"shortname": "Normalizes_One_Data_Point", "longname": "Normalizes One Data Point", "scenario": [{"action": "error", "message": "list index out of range"}]}, {"shortname": "Normalizes_Three_Data_Points", "longname": "Normalizes Three Data Points", "scenario": [{"action": "error", "message": "list index out of range"}]}, {"shortname": "Bounds_computation_to_the_number_of_data_points", "longname": "Bounds computation to the number of data points", "scenario": [{"action": "error", "message": "list index out of range"}]}, {"shortname": "Calls_back_correctly_when_a_valid_asset_is_provided", "longname": "Calls back correctly when a valid asset is provided", "scenario": [{"action": "error", "message": "list index out of range"}]}, {"shortname": "Fails_a_get_request_when_an_invalid_asset_is_provided", "longname": "Fails a get request when an invalid asset is provided", "scenario": [{"action": "error", "message": "list index out of range"}]}, {"shortname": "Unrelated_Assets_do_not_affect_normalizer", "longname": "Unrelated Assets do not affect normalizer", "scenario": [{"action": "error", "message": "list index out of range"}]}, {"shortname": "Computes_correctly_for_multiple_assets_in_parallel", "longname": "Computes correctly for multiple assets in parallel", "scenario": [{"action": "error", "message": "list index out of range"}]}, {"shortname": "Trims_multiple_assets_correctly", "longname": "Trims multiple assets correctly", "scenario": [{"action": "error", "message": "list index out of range"}]}]