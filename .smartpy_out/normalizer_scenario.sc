[{"shortname": "Fails_with_bad_contract_data", "longname": "Fails with bad contract data", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails when data is pushed from bad address", "line_no": 160}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract whitelisted to an address", "line_no": 162}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63) (literal (string \"BTC-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 166) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 166) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 166) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"BTC-USD\") 166) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 166) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 166) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_140\" (first (params 138) 140) 140) (defineLocal \"compute_141\" (second (params 138) 141) 141) (verify (contains (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 145) False (literal (string \"bad request\") 144) 144) (set (operations 151) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 150) \"computedPrice\" 150) (literal (mutez 0) 151) (getLocal \"compute_141\" 141) 151) (operations 151) 151) 151))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (verify (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) False 97) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 100) \"lastUpdateTime\" 100) (getLocal \"compute_96\" 96) 100) (defineLocal \"compute_103\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_107\" (second (getLocal \"compute_106\" 106) 107) 107) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (first (getLocal \"compute_107\" 107) 113) 113) (defineLocal \"compute_114\" (second (getLocal \"compute_107\" 107) 114) 114) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (literal (intOrNat 1) 119) 119) 119) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (getLocal \"compute_114\" 114) 119) 119) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"saved\" 119) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) 119) (getLocal \"compute_114\" 114) 119) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (literal (intOrNat 1) 122) 122) (attr (data) \"numDataPoints\" 122) 122) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"last\" 124) 124) False 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) 124) 124) \"Some\" 124) 124) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (literal (intOrNat 1) 124) 124) 124)) 122) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"computedPrice\" 127) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"prices\" 127) \"sum\" 127) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"volumes\" 127) \"sum\" 127) 127) 127)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 166, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN an update is pushed from the wrong address", "line_no": 168}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": 169}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 171) (tuple (literal (timestamp 1595104501) 174) (tuple (literal (timestamp 1595104531) 175) (tuple (literal (intOrNat 3059701) 171) (tuple (literal (intOrNat 1) 171) (tuple (literal (intOrNat 2) 171) (tuple (literal (intOrNat 3) 171) (literal (intOrNat 4) 171) 171) 171) 171) 171) 171) 171))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 171, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1FrRkunqmB7futF3EyRwTt8f7fPEVJW39P\") 170)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Fails_with_updates_from_the_same_time", "longname": "Fails with updates from the same time", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails with updates from the past", "line_no": 187}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract with an update at a given time = 1", "line_no": 189}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63) (literal (string \"BTC-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 192) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 192) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 192) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"BTC-USD\") 192) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 192) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 192) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_140\" (first (params 138) 140) 140) (defineLocal \"compute_141\" (second (params 138) 141) 141) (verify (contains (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 145) False (literal (string \"bad request\") 144) 144) (set (operations 151) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 150) \"computedPrice\" 150) (literal (mutez 0) 151) (getLocal \"compute_141\" 141) 151) (operations 151) 151) 151))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (verify (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) False 97) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 100) \"lastUpdateTime\" 100) (getLocal \"compute_96\" 96) 100) (defineLocal \"compute_103\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_107\" (second (getLocal \"compute_106\" 106) 107) 107) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (first (getLocal \"compute_107\" 107) 113) 113) (defineLocal \"compute_114\" (second (getLocal \"compute_107\" 107) 114) 114) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (literal (intOrNat 1) 119) 119) 119) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (getLocal \"compute_114\" 114) 119) 119) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"saved\" 119) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) 119) (getLocal \"compute_114\" 114) 119) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (literal (intOrNat 1) 122) 122) (attr (data) \"numDataPoints\" 122) 122) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"last\" 124) 124) False 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) 124) 124) \"Some\" 124) 124) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (literal (intOrNat 1) 124) 124) 124)) 122) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"computedPrice\" 127) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"prices\" 127) \"sum\" 127) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"volumes\" 127) \"sum\" 127) 127) 127)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 192, "show": true, "accept_unknown_types": false}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 193) (tuple (literal (timestamp 1) 190) (tuple (literal (timestamp 1595104531) 197) (tuple (literal (intOrNat 3059701) 193) (tuple (literal (intOrNat 1) 193) (tuple (literal (intOrNat 2) 193) (tuple (literal (intOrNat 3) 193) (literal (intOrNat 4) 193) 193) 193) 193) 193) 193) 193))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 193, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided at the same time.", "line_no": 206}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": 207}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 208) (tuple (literal (timestamp 1) 190) (tuple (literal (timestamp 1595104531) 212) (tuple (literal (intOrNat 3059701) 208) (tuple (literal (intOrNat 1) 208) (tuple (literal (intOrNat 2) 208) (tuple (literal (intOrNat 3) 208) (literal (intOrNat 4) 208) 208) 208) 208) 208) 208) 208))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 208, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Fails_with_updates_from_the_past_time", "longname": "Fails with updates from the past time", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails with updates from the past", "line_no": 224}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract with an update at a current time and a time in the past", "line_no": 226}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63) (literal (string \"BTC-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 231) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 231) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 231) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"BTC-USD\") 231) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 231) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 231) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_140\" (first (params 138) 140) 140) (defineLocal \"compute_141\" (second (params 138) 141) 141) (verify (contains (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 145) False (literal (string \"bad request\") 144) 144) (set (operations 151) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 150) \"computedPrice\" 150) (literal (mutez 0) 151) (getLocal \"compute_141\" 141) 151) (operations 151) 151) 151))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (verify (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) False 97) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 100) \"lastUpdateTime\" 100) (getLocal \"compute_96\" 96) 100) (defineLocal \"compute_103\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_107\" (second (getLocal \"compute_106\" 106) 107) 107) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (first (getLocal \"compute_107\" 107) 113) 113) (defineLocal \"compute_114\" (second (getLocal \"compute_107\" 107) 114) 114) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (literal (intOrNat 1) 119) 119) 119) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (getLocal \"compute_114\" 114) 119) 119) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"saved\" 119) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) 119) (getLocal \"compute_114\" 114) 119) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (literal (intOrNat 1) 122) 122) (attr (data) \"numDataPoints\" 122) 122) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"last\" 124) 124) False 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) 124) 124) \"Some\" 124) 124) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (literal (intOrNat 1) 124) 124) 124)) 122) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"computedPrice\" 127) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"prices\" 127) \"sum\" 127) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"volumes\" 127) \"sum\" 127) 127) 127)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 231, "show": true, "accept_unknown_types": false}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 232) (tuple (literal (timestamp 2) 228) (tuple (literal (timestamp 1595104531) 236) (tuple (literal (intOrNat 3059701) 232) (tuple (literal (intOrNat 1) 232) (tuple (literal (intOrNat 2) 232) (tuple (literal (intOrNat 3) 232) (literal (intOrNat 4) 232) 232) 232) 232) 232) 232) 232))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 232, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided from the past.", "line_no": 245}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": 246}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 247) (tuple (literal (timestamp 1) 229) (tuple (literal (timestamp 1595104531) 251) (tuple (literal (intOrNat 3059701) 247) (tuple (literal (intOrNat 1) 247) (tuple (literal (intOrNat 2) 247) (tuple (literal (intOrNat 3) 247) (literal (intOrNat 4) 247) 247) 247) 247) 247) 247) 247))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 247, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Normalizes_One_Data_Point", "longname": "Normalizes One Data Point", "scenario": [{"action": "html", "tag": "h1", "inner": "Normalizes One Data Point", "line_no": 263}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract.", "line_no": 265}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63) (literal (string \"BTC-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 267) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 267) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 267) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"BTC-USD\") 267) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 267) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 267) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_140\" (first (params 138) 140) 140) (defineLocal \"compute_141\" (second (params 138) 141) 141) (verify (contains (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 145) False (literal (string \"bad request\") 144) 144) (set (operations 151) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 150) \"computedPrice\" 150) (literal (mutez 0) 151) (getLocal \"compute_141\" 141) 151) (operations 151) 151) 151))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (verify (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) False 97) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 100) \"lastUpdateTime\" 100) (getLocal \"compute_96\" 96) 100) (defineLocal \"compute_103\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_107\" (second (getLocal \"compute_106\" 106) 107) 107) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (first (getLocal \"compute_107\" 107) 113) 113) (defineLocal \"compute_114\" (second (getLocal \"compute_107\" 107) 114) 114) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (literal (intOrNat 1) 119) 119) 119) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (getLocal \"compute_114\" 114) 119) 119) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"saved\" 119) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) 119) (getLocal \"compute_114\" 114) 119) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (literal (intOrNat 1) 122) 122) (attr (data) \"numDataPoints\" 122) 122) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"last\" 124) 124) False 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) 124) 124) \"Some\" 124) 124) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (literal (intOrNat 1) 124) 124) 124)) 122) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"computedPrice\" 127) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"prices\" 127) \"sum\" 127) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"volumes\" 127) \"sum\" 127) 127) 127)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 267, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided", "line_no": 276}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 277) (tuple (literal (timestamp 1595104530) 280) (tuple (literal (timestamp 1595104531) 281) (tuple (literal (intOrNat 3059701) 277) (tuple (literal (intOrNat 1) 277) (tuple (literal (intOrNat 2) 277) (tuple (literal (intOrNat 3) 277) (literal (intOrNat 4) 277) 277) 277) 277) 277) 277) 277))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 277, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the ComputedPrice is the VWAP.", "line_no": 290}, {"action": "verify", "condition": "(eq (attr (getItem (attr (contractData 0 277) \"assetMap\" 297) (literal (string \"XTZ-USD\") 297) 297) \"computedPrice\" 297) (literal (intOrNat 2) 297) 297)", "line_no": 297}]}, {"shortname": "Normalizes_Three_Data_Points", "longname": "Normalizes Three Data Points", "scenario": [{"action": "html", "tag": "h1", "inner": "Normalizes Three Data Points", "line_no": 302}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract", "line_no": 304}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63) (literal (string \"BTC-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 306) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 306) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 306) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"BTC-USD\") 306) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 306) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 306) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_140\" (first (params 138) 140) 140) (defineLocal \"compute_141\" (second (params 138) 141) 141) (verify (contains (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 145) False (literal (string \"bad request\") 144) 144) (set (operations 151) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 150) \"computedPrice\" 150) (literal (mutez 0) 151) (getLocal \"compute_141\" 141) 151) (operations 151) 151) 151))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (verify (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) False 97) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 100) \"lastUpdateTime\" 100) (getLocal \"compute_96\" 96) 100) (defineLocal \"compute_103\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_107\" (second (getLocal \"compute_106\" 106) 107) 107) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (first (getLocal \"compute_107\" 107) 113) 113) (defineLocal \"compute_114\" (second (getLocal \"compute_107\" 107) 114) 114) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (literal (intOrNat 1) 119) 119) 119) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (getLocal \"compute_114\" 114) 119) 119) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"saved\" 119) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) 119) (getLocal \"compute_114\" 114) 119) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (literal (intOrNat 1) 122) 122) (attr (data) \"numDataPoints\" 122) 122) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"last\" 124) 124) False 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) 124) 124) \"Some\" 124) 124) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (literal (intOrNat 1) 124) 124) 124)) 122) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"computedPrice\" 127) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"prices\" 127) \"sum\" 127) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"volumes\" 127) \"sum\" 127) 127) 127)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 306, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN three updates are provided", "line_no": 308}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 315) (tuple (literal (timestamp 1595104530) 318) (tuple (literal (timestamp 1595104531) 319) (tuple (literal (intOrNat 3059701) 315) (tuple (literal (intOrNat 1) 315) (tuple (literal (intOrNat 2) 315) (tuple (literal (intOrNat 3) 315) (literal (intOrNat 4) 315) 315) 315) 315) 315) 315) 315))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 315, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 332) (tuple (literal (timestamp 1595104532) 335) (tuple (literal (timestamp 1595104533) 336) (tuple (literal (intOrNat 3059701) 332) (tuple (literal (intOrNat 5) 332) (tuple (literal (intOrNat 6) 332) (tuple (literal (intOrNat 7) 332) (literal (intOrNat 8) 332) 332) 332) 332) 332) 332) 332))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 332, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 349) (tuple (literal (timestamp 1595104534) 352) (tuple (literal (timestamp 1595104535) 353) (tuple (literal (intOrNat 3059701) 349) (tuple (literal (intOrNat 9) 349) (tuple (literal (intOrNat 10) 349) (tuple (literal (intOrNat 11) 349) (literal (intOrNat 12) 349) 349) 349) 349) 349) 349) 349))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 349, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "WHEN the ComputedPrice is the VWAP of the updates", "line_no": 362}, {"action": "verify", "condition": "(eq (attr (getItem (attr (contractData 0 349) \"assetMap\" 384) (literal (string \"XTZ-USD\") 384) 384) \"computedPrice\" 384) (literal (intOrNat 7) 384) 384)", "line_no": 384}]}, {"shortname": "Bounds_computation_to_the_number_of_data_points", "longname": "Bounds computation to the number of data points", "scenario": [{"action": "html", "tag": "h1", "inner": "Bounds computation to the number of data points", "line_no": 390}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract set to only hold two data points", "line_no": 392}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63) (literal (string \"BTC-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 395) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 395) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 395) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"BTC-USD\") 395) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 395) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 395) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (intOrNat 2) 63)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_140\" (first (params 138) 140) 140) (defineLocal \"compute_141\" (second (params 138) 141) 141) (verify (contains (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 145) False (literal (string \"bad request\") 144) 144) (set (operations 151) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 150) \"computedPrice\" 150) (literal (mutez 0) 151) (getLocal \"compute_141\" 141) 151) (operations 151) 151) 151))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (verify (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) False 97) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 100) \"lastUpdateTime\" 100) (getLocal \"compute_96\" 96) 100) (defineLocal \"compute_103\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_107\" (second (getLocal \"compute_106\" 106) 107) 107) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (first (getLocal \"compute_107\" 107) 113) 113) (defineLocal \"compute_114\" (second (getLocal \"compute_107\" 107) 114) 114) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (literal (intOrNat 1) 119) 119) 119) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (getLocal \"compute_114\" 114) 119) 119) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"saved\" 119) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) 119) (getLocal \"compute_114\" 114) 119) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (literal (intOrNat 1) 122) 122) (attr (data) \"numDataPoints\" 122) 122) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"last\" 124) 124) False 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) 124) 124) \"Some\" 124) 124) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (literal (intOrNat 1) 124) 124) 124)) 122) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"computedPrice\" 127) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"prices\" 127) \"sum\" 127) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"volumes\" 127) \"sum\" 127) 127) 127)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 395, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN three updates are provided", "line_no": 397}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 404) (tuple (literal (timestamp 1595104530) 407) (tuple (literal (timestamp 1595104531) 408) (tuple (literal (intOrNat 3059701) 404) (tuple (literal (intOrNat 1) 404) (tuple (literal (intOrNat 2) 404) (tuple (literal (intOrNat 3) 404) (literal (intOrNat 4) 404) 404) 404) 404) 404) 404) 404))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 404, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 421) (tuple (literal (timestamp 1595104532) 424) (tuple (literal (timestamp 1595104533) 425) (tuple (literal (intOrNat 3059701) 421) (tuple (literal (intOrNat 5) 421) (tuple (literal (intOrNat 6) 421) (tuple (literal (intOrNat 7) 421) (literal (intOrNat 8) 421) 421) 421) 421) 421) 421) 421))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 421, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 438) (tuple (literal (timestamp 1595104534) 441) (tuple (literal (timestamp 1595104535) 442) (tuple (literal (intOrNat 3059701) 438) (tuple (literal (intOrNat 9) 438) (tuple (literal (intOrNat 10) 438) (tuple (literal (intOrNat 11) 438) (literal (intOrNat 12) 438) 438) 438) 438) 438) 438) 438))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 438, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the contract is only tracking two updates", "line_no": 451}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 438) \"assetMap\" 452) (literal (string \"XTZ-USD\") 452) 452) \"prices\" 452) \"last\" 452) (attr (attr (getItem (attr (contractData 0 438) \"assetMap\" 452) (literal (string \"XTZ-USD\") 452) 452) \"prices\" 452) \"first\" 452) 452) (literal (intOrNat 1) 452) 452) (literal (intOrNat 2) 452) 452)", "line_no": 452}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 438) \"assetMap\" 452) (literal (string \"XTZ-USD\") 453) 453) \"volumes\" 453) \"last\" 453) (attr (attr (getItem (attr (contractData 0 438) \"assetMap\" 452) (literal (string \"XTZ-USD\") 453) 453) \"volumes\" 453) \"first\" 453) 453) (literal (intOrNat 1) 453) 453) (literal (intOrNat 2) 453) 453)", "line_no": 453}, {"action": "html", "tag": "h2", "inner": "AND the computed price is the VWAP of the latter two updates", "line_no": 455}, {"action": "verify", "condition": "(eq (attr (getItem (attr (contractData 0 438) \"assetMap\" 452) (literal (string \"XTZ-USD\") 469) 469) \"computedPrice\" 469) (literal (intOrNat 8) 469) 469)", "line_no": 469}]}, {"shortname": "Calls_back_correctly_when_a_valid_asset_is_provided", "longname": "Calls back correctly when a valid asset is provided", "scenario": [{"action": "html", "tag": "h1", "inner": "Calls back correctly when a valid asset is provided", "line_no": 474}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract", "line_no": 476}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 479) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 479) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 479) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_140\" (first (params 138) 140) 140) (defineLocal \"compute_141\" (second (params 138) 141) 141) (verify (contains (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 145) False (literal (string \"bad request\") 144) 144) (set (operations 151) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 150) \"computedPrice\" 150) (literal (mutez 0) 151) (getLocal \"compute_141\" 141) 151) (operations 151) 151) 151))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (verify (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) False 97) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 100) \"lastUpdateTime\" 100) (getLocal \"compute_96\" 96) 100) (defineLocal \"compute_103\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_107\" (second (getLocal \"compute_106\" 106) 107) 107) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (first (getLocal \"compute_107\" 107) 113) 113) (defineLocal \"compute_114\" (second (getLocal \"compute_107\" 107) 114) 114) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (literal (intOrNat 1) 119) 119) 119) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (getLocal \"compute_114\" 114) 119) 119) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"saved\" 119) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) 119) (getLocal \"compute_114\" 114) 119) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (literal (intOrNat 1) 122) 122) (attr (data) \"numDataPoints\" 122) 122) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"last\" 124) 124) False 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) 124) 124) \"Some\" 124) 124) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (literal (intOrNat 1) 124) 124) 124)) 122) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"computedPrice\" 127) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"prices\" 127) \"sum\" 127) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"volumes\" 127) \"sum\" 127) 127) 127)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 479, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "AND a contract to call back to", "line_no": 481}, {"action": "newContract", "id": 1, "export": "(storage (record 930 )\nstorage_type (())\nmessages ((callback True ()))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 483, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN a request is made", "line_no": 485}, {"action": "html", "tag": "h2", "inner": "THEN it succeeds.", "line_no": 493}, {"action": "message", "id": 0, "message": "get", "params": "(tuple (literal (string \"XTZ-USD\") 494) (openVariant (contract \"callback\" \"nat\" (literal (local-address 1) 930) 486) \"Some\" 486) 494)", "line_no": 494, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}]}, {"shortname": "Fails_a_get_request_when_an_invalid_asset_is_provided", "longname": "Fails a get request when an invalid asset is provided", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails a get request when an invalid asset is provided", "line_no": 499}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract", "line_no": 501}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 504) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 504) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 504) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_140\" (first (params 138) 140) 140) (defineLocal \"compute_141\" (second (params 138) 141) 141) (verify (contains (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 145) False (literal (string \"bad request\") 144) 144) (set (operations 151) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 150) \"computedPrice\" 150) (literal (mutez 0) 151) (getLocal \"compute_141\" 141) 151) (operations 151) 151) 151))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (verify (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) False 97) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 100) \"lastUpdateTime\" 100) (getLocal \"compute_96\" 96) 100) (defineLocal \"compute_103\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_107\" (second (getLocal \"compute_106\" 106) 107) 107) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (first (getLocal \"compute_107\" 107) 113) 113) (defineLocal \"compute_114\" (second (getLocal \"compute_107\" 107) 114) 114) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (literal (intOrNat 1) 119) 119) 119) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (getLocal \"compute_114\" 114) 119) 119) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"saved\" 119) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) 119) (getLocal \"compute_114\" 114) 119) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (literal (intOrNat 1) 122) 122) (attr (data) \"numDataPoints\" 122) 122) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"last\" 124) 124) False 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) 124) 124) \"Some\" 124) 124) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (literal (intOrNat 1) 124) 124) 124)) 122) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"computedPrice\" 127) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"prices\" 127) \"sum\" 127) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"volumes\" 127) \"sum\" 127) 127) 127)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 504, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "AND a contract to call back to", "line_no": 506}, {"action": "newContract", "id": 1, "export": "(storage (record 930 )\nstorage_type (())\nmessages ((callback True ()))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 508, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN a request is made", "line_no": 510}, {"action": "html", "tag": "h2", "inner": "THEN it fails.", "line_no": 519}, {"action": "message", "id": 0, "message": "get", "params": "(tuple (literal (string \"BTC-USD\") 520) (openVariant (contract \"callback\" \"nat\" (literal (local-address 1) 930) 511) \"Some\" 511) 520)", "line_no": 520, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Unrelated_Assets_do_not_affect_normalizer", "longname": "Unrelated Assets do not affect normalizer", "scenario": [{"action": "html", "tag": "h1", "inner": "Unrelated Assets do not affect normalizer", "line_no": 525}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract", "line_no": 527}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"XTZ-USD\") 63) (literal (string \"BTC-USD\") 63))) (assetMap (big_map 59 ((literal (string \"XTZ-USD\") 529) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 529) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 529) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"BTC-USD\") 529) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 529) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 529) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_140\" (first (params 138) 140) 140) (defineLocal \"compute_141\" (second (params 138) 141) 141) (verify (contains (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 145) False (literal (string \"bad request\") 144) 144) (set (operations 151) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 150) \"computedPrice\" 150) (literal (mutez 0) 151) (getLocal \"compute_141\" 141) 151) (operations 151) 151) 151))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (verify (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) False 97) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 100) \"lastUpdateTime\" 100) (getLocal \"compute_96\" 96) 100) (defineLocal \"compute_103\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_107\" (second (getLocal \"compute_106\" 106) 107) 107) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (first (getLocal \"compute_107\" 107) 113) 113) (defineLocal \"compute_114\" (second (getLocal \"compute_107\" 107) 114) 114) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (literal (intOrNat 1) 119) 119) 119) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (getLocal \"compute_114\" 114) 119) 119) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"saved\" 119) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) 119) (getLocal \"compute_114\" 114) 119) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (literal (intOrNat 1) 122) 122) (attr (data) \"numDataPoints\" 122) 122) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"last\" 124) 124) False 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) 124) 124) \"Some\" 124) 124) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (literal (intOrNat 1) 124) 124) 124)) 122) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"computedPrice\" 127) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"prices\" 127) \"sum\" 127) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"volumes\" 127) \"sum\" 127) 127) 127)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 529, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN two updates are provided for the asset", "line_no": 531}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 538) (tuple (literal (timestamp 1595104530) 541) (tuple (literal (timestamp 1595104531) 542) (tuple (literal (intOrNat 3059701) 538) (tuple (literal (intOrNat 1) 538) (tuple (literal (intOrNat 2) 538) (tuple (literal (intOrNat 3) 538) (literal (intOrNat 4) 538) 538) 538) 538) 538) 538) 538))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 538, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"XTZ-USD\") 555) (tuple (literal (timestamp 1595104532) 558) (tuple (literal (timestamp 1595104533) 559) (tuple (literal (intOrNat 3059701) 555) (tuple (literal (intOrNat 5) 555) (tuple (literal (intOrNat 6) 555) (tuple (literal (intOrNat 7) 555) (literal (intOrNat 8) 555) 555) 555) 555) 555) 555) 555))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 555, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 911 ((literal (string \"BTC-USD\") 573) (tuple (literal (timestamp 1595104534) 576) (tuple (literal (timestamp 1595104535) 577) (tuple (literal (intOrNat 3059701) 573) (tuple (literal (intOrNat 9) 573) (tuple (literal (intOrNat 10) 573) (tuple (literal (intOrNat 11) 573) (literal (intOrNat 12) 573) 573) 573) 573) 573) 573) 573))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 911)", "line_no": 573, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the contract is only tracking two updates for the tracked asset", "line_no": 586}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 573) \"assetMap\" 587) (literal (string \"XTZ-USD\") 587) 587) \"prices\" 587) \"last\" 587) (attr (attr (getItem (attr (contractData 0 573) \"assetMap\" 587) (literal (string \"XTZ-USD\") 587) 587) \"prices\" 587) \"first\" 587) 587) (literal (intOrNat 1) 587) 587) (literal (intOrNat 2) 587) 587)", "line_no": 587}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 573) \"assetMap\" 587) (literal (string \"XTZ-USD\") 588) 588) \"volumes\" 588) \"last\" 588) (attr (attr (getItem (attr (contractData 0 573) \"assetMap\" 587) (literal (string \"XTZ-USD\") 588) 588) \"volumes\" 588) \"first\" 588) 588) (literal (intOrNat 1) 588) 588) (literal (intOrNat 2) 588) 588)", "line_no": 588}, {"action": "html", "tag": "h2", "inner": "AND the computed price is the VWAP of the two updates", "line_no": 590}, {"action": "verify", "condition": "(eq (attr (getItem (attr (contractData 0 573) \"assetMap\" 587) (literal (string \"XTZ-USD\") 604) 604) \"computedPrice\" 604) (literal (intOrNat 4) 604) 604)", "line_no": 604}]}, {"shortname": "Computes_correctly_for_multiple_assets_in_parallel", "longname": "Computes correctly for multiple assets in parallel", "scenario": [{"action": "html", "tag": "h1", "inner": "Computes correctly for multiple assets in parallel", "line_no": 609}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract for two assets", "line_no": 611}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"BTC-USD\") 63) (literal (string \"XTZ-USD\") 63))) (assetMap (big_map 59 ((literal (string \"BTC-USD\") 615) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 615) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 615) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"XTZ-USD\") 615) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 615) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 615) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_140\" (first (params 138) 140) 140) (defineLocal \"compute_141\" (second (params 138) 141) 141) (verify (contains (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 145) False (literal (string \"bad request\") 144) 144) (set (operations 151) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 150) \"computedPrice\" 150) (literal (mutez 0) 151) (getLocal \"compute_141\" 141) 151) (operations 151) 151) 151))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (verify (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) False 97) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 100) \"lastUpdateTime\" 100) (getLocal \"compute_96\" 96) 100) (defineLocal \"compute_103\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_107\" (second (getLocal \"compute_106\" 106) 107) 107) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (first (getLocal \"compute_107\" 107) 113) 113) (defineLocal \"compute_114\" (second (getLocal \"compute_107\" 107) 114) 114) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (literal (intOrNat 1) 119) 119) 119) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (getLocal \"compute_114\" 114) 119) 119) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"saved\" 119) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) 119) (getLocal \"compute_114\" 114) 119) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (literal (intOrNat 1) 122) 122) (attr (data) \"numDataPoints\" 122) 122) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"last\" 124) 124) False 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) 124) 124) \"Some\" 124) 124) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (literal (intOrNat 1) 124) 124) 124)) 122) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"computedPrice\" 127) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"prices\" 127) \"sum\" 127) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"volumes\" 127) \"sum\" 127) 127) 127)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 615, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN two updates are provided which touch both assets", "line_no": 617}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 630 ((literal (string \"BTC-USD\") 654) (tuple (literal (timestamp 1) 633) (tuple (literal (timestamp 2) 634) (tuple (literal (intOrNat 1) 654) (tuple (literal (intOrNat 1) 654) (tuple (literal (intOrNat 2) 654) (tuple (literal (intOrNat 3) 654) (literal (intOrNat 4) 654) 654) 654) 654) 654) 654) 654)) ((literal (string \"XTZ-USD\") 654) (tuple (literal (timestamp 1) 642) (tuple (literal (timestamp 2) 643) (tuple (literal (intOrNat 5) 654) (tuple (literal (intOrNat 5) 654) (tuple (literal (intOrNat 6) 654) (tuple (literal (intOrNat 7) 654) (literal (intOrNat 8) 654) 654) 654) 654) 654) 654) 654))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 630)", "line_no": 654, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 670 ((literal (string \"BTC-USD\") 694) (tuple (literal (timestamp 3) 673) (tuple (literal (timestamp 4) 674) (tuple (literal (intOrNat 9) 694) (tuple (literal (intOrNat 9) 694) (tuple (literal (intOrNat 10) 694) (tuple (literal (intOrNat 11) 694) (literal (intOrNat 12) 694) 694) 694) 694) 694) 694) 694)) ((literal (string \"XTZ-USD\") 694) (tuple (literal (timestamp 3) 682) (tuple (literal (timestamp 4) 683) (tuple (literal (intOrNat 13) 694) (tuple (literal (intOrNat 13) 694) (tuple (literal (intOrNat 14) 694) (tuple (literal (intOrNat 15) 694) (literal (intOrNat 6) 694) 694) 694) 694) 694) 694) 694))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 670)", "line_no": 694, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the contract is only tracking two updates for each asset", "line_no": 698}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 694) \"assetMap\" 699) (literal (string \"BTC-USD\") 699) 699) \"prices\" 699) \"last\" 699) (attr (attr (getItem (attr (contractData 0 694) \"assetMap\" 699) (literal (string \"BTC-USD\") 699) 699) \"prices\" 699) \"first\" 699) 699) (literal (intOrNat 1) 699) 699) (literal (intOrNat 2) 699) 699)", "line_no": 699}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 694) \"assetMap\" 699) (literal (string \"BTC-USD\") 700) 700) \"volumes\" 700) \"last\" 700) (attr (attr (getItem (attr (contractData 0 694) \"assetMap\" 699) (literal (string \"BTC-USD\") 700) 700) \"volumes\" 700) \"first\" 700) 700) (literal (intOrNat 1) 700) 700) (literal (intOrNat 2) 700) 700)", "line_no": 700}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 694) \"assetMap\" 699) (literal (string \"XTZ-USD\") 701) 701) \"prices\" 701) \"last\" 701) (attr (attr (getItem (attr (contractData 0 694) \"assetMap\" 699) (literal (string \"XTZ-USD\") 701) 701) \"prices\" 701) \"first\" 701) 701) (literal (intOrNat 1) 701) 701) (literal (intOrNat 2) 701) 701)", "line_no": 701}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 694) \"assetMap\" 699) (literal (string \"XTZ-USD\") 702) 702) \"volumes\" 702) \"last\" 702) (attr (attr (getItem (attr (contractData 0 694) \"assetMap\" 699) (literal (string \"XTZ-USD\") 702) 702) \"volumes\" 702) \"first\" 702) 702) (literal (intOrNat 1) 702) 702) (literal (intOrNat 2) 702) 702)", "line_no": 702}, {"action": "html", "tag": "h2", "inner": "AND the computed price is the VWAP of the two updates", "line_no": 704}, {"action": "verify", "condition": "(eq (attr (getItem (attr (contractData 0 694) \"assetMap\" 699) (literal (string \"BTC-USD\") 732) 732) \"computedPrice\" 732) (literal (intOrNat 8) 732) 732)", "line_no": 732}, {"action": "verify", "condition": "(eq (attr (getItem (attr (contractData 0 694) \"assetMap\" 699) (literal (string \"XTZ-USD\") 733) 733) \"computedPrice\" 733) (literal (intOrNat 9) 733) 733)", "line_no": 733}]}, {"shortname": "Trims_multiple_assets_correctly", "longname": "Trims multiple assets correctly", "scenario": [{"action": "html", "tag": "h1", "inner": "Trims multiple assets correctly", "line_no": 739}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract for two assets", "line_no": 741}, {"action": "newContract", "id": 0, "export": "(storage (record 63 (assetCodes (list 63 (literal (string \"BTC-USD\") 63) (literal (string \"XTZ-USD\") 63))) (assetMap (big_map 59 ((literal (string \"BTC-USD\") 745) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 745) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 745) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))) ((literal (string \"XTZ-USD\") 745) (record 51 (computedPrice (literal (intOrNat 0) 51)) (lastUpdateTime (literal (timestamp 0) 43)) (prices (record 48 (first (literal (intOrNat 0) 48)) (last (literal (int -1) 48)) (saved (map 48 ((literal (intOrNat 0) 745) (literal (nat 0) 48)))) (sum (literal (nat 0) 48)))) (volumes (record 49 (first (literal (intOrNat 0) 49)) (last (literal (int -1) 49)) (saved (map 49 ((literal (intOrNat 0) 745) (literal (nat 0) 49)))) (sum (literal (nat 0) 49)))))))) (numDataPoints (literal (intOrNat 2) 63)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 35)))\nstorage_type (())\nmessages ((get True ((defineLocal \"compute_140\" (first (params 138) 140) 140) (defineLocal \"compute_141\" (second (params 138) 141) 141) (verify (contains (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 145) False (literal (string \"bad request\") 144) 144) (set (operations 151) (cons (transfer (attr (getItem (attr (data) \"assetMap\" 145) (getLocal \"compute_140\" 140) 150) \"computedPrice\" 150) (literal (mutez 0) 151) (getLocal \"compute_141\" 141) 151) (operations 151) 151) 151))) (update True ((set_type (params 80) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 81) (verify (eq (sender) (attr (data) \"oracleContract\" 85) 85) False (literal (string \"bad sender\") 84) 84) (forGroup \"assetCode\" (attr (data) \"assetCodes\" 90) ((ifBlock (contains (params 80) (iter \"assetCode\" 90) 92) ((defineLocal \"compute_96\" (first (getItem (params 80) (iter \"assetCode\" 90) 93) 96) 96) (verify (gt (getLocal \"compute_96\" 96) (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 97) \"lastUpdateTime\" 97) 97) False 97) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 100) \"lastUpdateTime\" 100) (getLocal \"compute_96\" 96) 100) (defineLocal \"compute_103\" (second (getItem (params 80) (iter \"assetCode\" 90) 93) 103) 103) (defineLocal \"compute_104\" (second (getLocal \"compute_103\" 103) 104) 104) (defineLocal \"compute_105\" (second (getLocal \"compute_104\" 104) 105) 105) (defineLocal \"compute_106\" (second (getLocal \"compute_105\" 105) 106) 106) (defineLocal \"compute_107\" (second (getLocal \"compute_106\" 106) 107) 107) (defineLocal \"compute_111\" (first (getLocal \"compute_105\" 105) 111) 111) (defineLocal \"compute_112\" (first (getLocal \"compute_106\" 106) 112) 112) (defineLocal \"compute_113\" (first (getLocal \"compute_107\" 107) 113) 113) (defineLocal \"compute_114\" (second (getLocal \"compute_107\" 107) 114) 114) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) (literal (intOrNat 1) 118) 118) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"sum\" 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) 118) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"saved\" 118) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 118) \"prices\" 118) \"last\" 118) 118) (mul (truediv (add (add (getLocal \"compute_111\" 111) (getLocal \"compute_112\" 112) 115) (getLocal \"compute_113\" 113) 115) (literal (intOrNat 3) 115) 115) (getLocal \"compute_114\" 114) 115) 118) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) (literal (intOrNat 1) 119) 119) 119) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"sum\" 119) (getLocal \"compute_114\" 114) 119) 119) (set (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"saved\" 119) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 119) \"volumes\" 119) \"last\" 119) 119) (getLocal \"compute_114\" 114) 119) (ifBlock (gt (add (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"last\" 122) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 122) \"prices\" 122) \"first\" 122) 122) (literal (intOrNat 1) 122) 122) (attr (data) \"numDataPoints\" 122) 122) ((verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"last\" 123) 123) False 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"sum\" 123) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) 123) 123) \"Some\" 123) 123) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"saved\" 123) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) 123) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 123) \"prices\" 123) \"first\" 123) (literal (intOrNat 1) 123) 123) 123) (verify (lt (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"last\" 124) 124) False 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (openVariant (isNat (sub (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"sum\" 124) (getItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) 124) 124) \"Some\" 124) 124) (delItem (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"saved\" 124) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) 124) (set (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (add (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 124) \"volumes\" 124) \"first\" 124) (literal (intOrNat 1) 124) 124) 124)) 122) (set (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"computedPrice\" 127) (truediv (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"prices\" 127) \"sum\" 127) (attr (attr (getItem (attr (data) \"assetMap\" 145) (iter \"assetCode\" 90) 127) \"volumes\" 127) \"sum\" 127) 127) 127)) 92)) 90))))\nflags (Exception_Unit no_comment)\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 745, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN two updates are provided which touch both assets", "line_no": 747}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 760 ((literal (string \"BTC-USD\") 784) (tuple (literal (timestamp 1) 763) (tuple (literal (timestamp 2) 764) (tuple (literal (intOrNat 2) 784) (tuple (literal (intOrNat 1) 784) (tuple (literal (intOrNat 3) 784) (tuple (literal (intOrNat 4) 784) (literal (intOrNat 5) 784) 784) 784) 784) 784) 784) 784)) ((literal (string \"XTZ-USD\") 784) (tuple (literal (timestamp 1) 772) (tuple (literal (timestamp 2) 773) (tuple (literal (intOrNat 7) 784) (tuple (literal (intOrNat 6) 784) (tuple (literal (intOrNat 8) 784) (tuple (literal (intOrNat 9) 784) (literal (intOrNat 10) 784) 784) 784) 784) 784) 784) 784))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 760)", "line_no": 784, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 800 ((literal (string \"BTC-USD\") 824) (tuple (literal (timestamp 3) 803) (tuple (literal (timestamp 4) 804) (tuple (literal (intOrNat 12) 824) (tuple (literal (intOrNat 11) 824) (tuple (literal (intOrNat 13) 824) (tuple (literal (intOrNat 14) 824) (literal (intOrNat 15) 824) 824) 824) 824) 824) 824) 824)) ((literal (string \"XTZ-USD\") 824) (tuple (literal (timestamp 3) 812) (tuple (literal (timestamp 4) 813) (tuple (literal (intOrNat 17) 824) (tuple (literal (intOrNat 16) 824) (tuple (literal (intOrNat 18) 824) (tuple (literal (intOrNat 19) 824) (literal (intOrNat 20) 824) 824) 824) 824) 824) 824) 824))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 800)", "line_no": 824, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "AND a third update is provided for the second asset", "line_no": 828}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 835 ((literal (string \"XTZ-USD\") 850) (tuple (literal (timestamp 5) 838) (tuple (literal (timestamp 6) 839) (tuple (literal (intOrNat 22) 850) (tuple (literal (intOrNat 21) 850) (tuple (literal (intOrNat 23) 850) (tuple (literal (intOrNat 24) 850) (literal (intOrNat 25) 850) 850) 850) 850) 850) 850) 850))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 835)", "line_no": 850, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 902)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the contract is only tracking two updates for each asset", "line_no": 855}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 850) \"assetMap\" 856) (literal (string \"BTC-USD\") 856) 856) \"prices\" 856) \"last\" 856) (attr (attr (getItem (attr (contractData 0 850) \"assetMap\" 856) (literal (string \"BTC-USD\") 856) 856) \"prices\" 856) \"first\" 856) 856) (literal (intOrNat 1) 856) 856) (literal (intOrNat 2) 856) 856)", "line_no": 856}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 850) \"assetMap\" 856) (literal (string \"BTC-USD\") 857) 857) \"volumes\" 857) \"last\" 857) (attr (attr (getItem (attr (contractData 0 850) \"assetMap\" 856) (literal (string \"BTC-USD\") 857) 857) \"volumes\" 857) \"first\" 857) 857) (literal (intOrNat 1) 857) 857) (literal (intOrNat 2) 857) 857)", "line_no": 857}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 850) \"assetMap\" 856) (literal (string \"XTZ-USD\") 858) 858) \"prices\" 858) \"last\" 858) (attr (attr (getItem (attr (contractData 0 850) \"assetMap\" 856) (literal (string \"XTZ-USD\") 858) 858) \"prices\" 858) \"first\" 858) 858) (literal (intOrNat 1) 858) 858) (literal (intOrNat 2) 858) 858)", "line_no": 858}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (getItem (attr (contractData 0 850) \"assetMap\" 856) (literal (string \"XTZ-USD\") 859) 859) \"volumes\" 859) \"last\" 859) (attr (attr (getItem (attr (contractData 0 850) \"assetMap\" 856) (literal (string \"XTZ-USD\") 859) 859) \"volumes\" 859) \"first\" 859) 859) (literal (intOrNat 1) 859) 859) (literal (intOrNat 2) 859) 859)", "line_no": 859}, {"action": "html", "tag": "h2", "inner": "AND the computed price of the first asset is the VWAP of the first two updates", "line_no": 861}, {"action": "verify", "condition": "(eq (attr (getItem (attr (contractData 0 850) \"assetMap\" 856) (literal (string \"BTC-USD\") 875) 875) \"computedPrice\" 875) (literal (intOrNat 9) 875) 875)", "line_no": 875}, {"action": "html", "tag": "h2", "inner": "AND the computed price of the second asset is the VWAP of the last two updates", "line_no": 877}, {"action": "verify", "condition": "(eq (attr (getItem (attr (contractData 0 850) \"assetMap\" 856) (literal (string \"XTZ-USD\") 891) 891) \"computedPrice\" 891) (literal (intOrNat 19) 891) 891)", "line_no": 891}]}]