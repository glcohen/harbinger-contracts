[{"shortname": "Fails_with_bad_contract_data", "longname": "Fails with bad contract data", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails when data is pushed from bad address", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract whitelisted to an address", "line_no": -1}, {"action": "newContract", "id": 0, "export": "(storage (record -1 (assetCode (literal (string \"XTZ-USD\") -1)) (computedPrice (literal (intOrNat 0) -1)) (lastUpdateTime (literal (timestamp 0) -1)) (numDataPoints (literal (int 3) 137)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)) (prices (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))) (volumes (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))))\nstorage_type (())\nmessages ((get True ((set (operations -1) (cons (transfer (attr (data) \"computedPrice\" -1) (literal (mutez 0) -1) (params 137) -1) (operations -1) -1) -1))) (update True ((set_type (params 137) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1) (verify (eq (sender) (attr (data) \"oracleContract\" -1) -1) False (literal (string \"Can only be called by the oracle contract.\") -1) -1) (defineLocal \"compute_-1\" (getItem (params 137) (attr (data) \"assetCode\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (verify (gt (getLocal \"compute_-1\" -1) (attr (data) \"lastUpdateTime\" -1) -1) False -1) (set (attr (data) \"lastUpdateTime\" -1) (getLocal \"compute_-1\" -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"last\" -1) (add (attr (attr (data) \"prices\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (add (attr (attr (data) \"prices\" -1) \"sum\" -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) -1) (set (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"last\" -1) (add (attr (attr (data) \"volumes\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (add (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getLocal \"compute_-1\" -1) -1) -1) (set (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) (getLocal \"compute_-1\" -1) -1) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" -1) \"last\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (literal (intOrNat 1) -1) -1) (attr (data) \"numDataPoints\" -1) -1) ((verify (lt (attr (attr (data) \"prices\" -1) \"first\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"prices\" -1) \"sum\" -1) (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (set (attr (attr (data) \"prices\" -1) \"first\" -1) (add (attr (attr (data) \"prices\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1) (verify (lt (attr (attr (data) \"volumes\" -1) \"first\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) (set (attr (attr (data) \"volumes\" -1) \"first\" -1) (add (attr (attr (data) \"volumes\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1)) -1) (set (attr (data) \"computedPrice\" -1) (truediv (attr (attr (data) \"prices\" -1) \"sum\" -1) (attr (attr (data) \"volumes\" -1) \"sum\" -1) -1) -1))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": -1, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN an update is pushed from the wrong address", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": -1}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1595104501) -1) (tuple (literal (timestamp 1595104531) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 1) -1) (tuple (literal (intOrNat 2) -1) (tuple (literal (intOrNat 3) -1) (literal (intOrNat 4) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1FrRkunqmB7futF3EyRwTt8f7fPEVJW39P\") -1)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Fails_with_updates_from_the_same_time", "longname": "Fails with updates from the same time", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails with updates from the past", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract with an update at a given time = 1", "line_no": -1}, {"action": "newContract", "id": 0, "export": "(storage (record -1 (assetCode (literal (string \"XTZ-USD\") -1)) (computedPrice (literal (intOrNat 0) -1)) (lastUpdateTime (literal (timestamp 0) -1)) (numDataPoints (literal (int 3) 137)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)) (prices (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))) (volumes (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))))\nstorage_type (())\nmessages ((get True ((set (operations -1) (cons (transfer (attr (data) \"computedPrice\" -1) (literal (mutez 0) -1) (params 137) -1) (operations -1) -1) -1))) (update True ((set_type (params 137) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1) (verify (eq (sender) (attr (data) \"oracleContract\" -1) -1) False (literal (string \"Can only be called by the oracle contract.\") -1) -1) (defineLocal \"compute_-1\" (getItem (params 137) (attr (data) \"assetCode\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (verify (gt (getLocal \"compute_-1\" -1) (attr (data) \"lastUpdateTime\" -1) -1) False -1) (set (attr (data) \"lastUpdateTime\" -1) (getLocal \"compute_-1\" -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"last\" -1) (add (attr (attr (data) \"prices\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (add (attr (attr (data) \"prices\" -1) \"sum\" -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) -1) (set (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"last\" -1) (add (attr (attr (data) \"volumes\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (add (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getLocal \"compute_-1\" -1) -1) -1) (set (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) (getLocal \"compute_-1\" -1) -1) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" -1) \"last\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (literal (intOrNat 1) -1) -1) (attr (data) \"numDataPoints\" -1) -1) ((verify (lt (attr (attr (data) \"prices\" -1) \"first\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"prices\" -1) \"sum\" -1) (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (set (attr (attr (data) \"prices\" -1) \"first\" -1) (add (attr (attr (data) \"prices\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1) (verify (lt (attr (attr (data) \"volumes\" -1) \"first\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) (set (attr (attr (data) \"volumes\" -1) \"first\" -1) (add (attr (attr (data) \"volumes\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1)) -1) (set (attr (data) \"computedPrice\" -1) (truediv (attr (attr (data) \"prices\" -1) \"sum\" -1) (attr (attr (data) \"volumes\" -1) \"sum\" -1) -1) -1))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": -1, "show": true, "accept_unknown_types": false}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1) -1) (tuple (literal (timestamp 1595104531) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 1) -1) (tuple (literal (intOrNat 2) -1) (tuple (literal (intOrNat 3) -1) (literal (intOrNat 4) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided at the same time.", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": -1}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1) -1) (tuple (literal (timestamp 1595104531) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 1) -1) (tuple (literal (intOrNat 2) -1) (tuple (literal (intOrNat 3) -1) (literal (intOrNat 4) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Fails_with_updates_from_the_past_time", "longname": "Fails with updates from the past time", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails with updates from the past", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract with an update at a current time and a time in the past", "line_no": -1}, {"action": "newContract", "id": 0, "export": "(storage (record -1 (assetCode (literal (string \"XTZ-USD\") -1)) (computedPrice (literal (intOrNat 0) -1)) (lastUpdateTime (literal (timestamp 0) -1)) (numDataPoints (literal (int 3) 137)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)) (prices (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))) (volumes (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))))\nstorage_type (())\nmessages ((get True ((set (operations -1) (cons (transfer (attr (data) \"computedPrice\" -1) (literal (mutez 0) -1) (params 137) -1) (operations -1) -1) -1))) (update True ((set_type (params 137) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1) (verify (eq (sender) (attr (data) \"oracleContract\" -1) -1) False (literal (string \"Can only be called by the oracle contract.\") -1) -1) (defineLocal \"compute_-1\" (getItem (params 137) (attr (data) \"assetCode\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (verify (gt (getLocal \"compute_-1\" -1) (attr (data) \"lastUpdateTime\" -1) -1) False -1) (set (attr (data) \"lastUpdateTime\" -1) (getLocal \"compute_-1\" -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"last\" -1) (add (attr (attr (data) \"prices\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (add (attr (attr (data) \"prices\" -1) \"sum\" -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) -1) (set (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"last\" -1) (add (attr (attr (data) \"volumes\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (add (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getLocal \"compute_-1\" -1) -1) -1) (set (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) (getLocal \"compute_-1\" -1) -1) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" -1) \"last\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (literal (intOrNat 1) -1) -1) (attr (data) \"numDataPoints\" -1) -1) ((verify (lt (attr (attr (data) \"prices\" -1) \"first\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"prices\" -1) \"sum\" -1) (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (set (attr (attr (data) \"prices\" -1) \"first\" -1) (add (attr (attr (data) \"prices\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1) (verify (lt (attr (attr (data) \"volumes\" -1) \"first\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) (set (attr (attr (data) \"volumes\" -1) \"first\" -1) (add (attr (attr (data) \"volumes\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1)) -1) (set (attr (data) \"computedPrice\" -1) (truediv (attr (attr (data) \"prices\" -1) \"sum\" -1) (attr (attr (data) \"volumes\" -1) \"sum\" -1) -1) -1))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": -1, "show": true, "accept_unknown_types": false}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 2) -1) (tuple (literal (timestamp 1595104531) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 1) -1) (tuple (literal (intOrNat 2) -1) (tuple (literal (intOrNat 3) -1) (literal (intOrNat 4) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided from the past.", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": -1}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1) -1) (tuple (literal (timestamp 1595104531) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 1) -1) (tuple (literal (intOrNat 2) -1) (tuple (literal (intOrNat 3) -1) (literal (intOrNat 4) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Fails_with_updates_for_the_wrong_asset", "longname": "Fails with updates for the wrong asset", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails with updates from the wrong asset", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract for the bitcoin price", "line_no": -1}, {"action": "newContract", "id": 0, "export": "(storage (record -1 (assetCode (literal (string \"BTC-USD\") -1)) (computedPrice (literal (intOrNat 0) -1)) (lastUpdateTime (literal (timestamp 0) -1)) (numDataPoints (literal (int 3) 137)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)) (prices (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))) (volumes (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))))\nstorage_type (())\nmessages ((get True ((set (operations -1) (cons (transfer (attr (data) \"computedPrice\" -1) (literal (mutez 0) -1) (params 137) -1) (operations -1) -1) -1))) (update True ((set_type (params 137) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1) (verify (eq (sender) (attr (data) \"oracleContract\" -1) -1) False (literal (string \"Can only be called by the oracle contract.\") -1) -1) (defineLocal \"compute_-1\" (getItem (params 137) (attr (data) \"assetCode\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (verify (gt (getLocal \"compute_-1\" -1) (attr (data) \"lastUpdateTime\" -1) -1) False -1) (set (attr (data) \"lastUpdateTime\" -1) (getLocal \"compute_-1\" -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"last\" -1) (add (attr (attr (data) \"prices\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (add (attr (attr (data) \"prices\" -1) \"sum\" -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) -1) (set (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"last\" -1) (add (attr (attr (data) \"volumes\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (add (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getLocal \"compute_-1\" -1) -1) -1) (set (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) (getLocal \"compute_-1\" -1) -1) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" -1) \"last\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (literal (intOrNat 1) -1) -1) (attr (data) \"numDataPoints\" -1) -1) ((verify (lt (attr (attr (data) \"prices\" -1) \"first\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"prices\" -1) \"sum\" -1) (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (set (attr (attr (data) \"prices\" -1) \"first\" -1) (add (attr (attr (data) \"prices\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1) (verify (lt (attr (attr (data) \"volumes\" -1) \"first\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) (set (attr (attr (data) \"volumes\" -1) \"first\" -1) (add (attr (attr (data) \"volumes\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1)) -1) (set (attr (data) \"computedPrice\" -1) (truediv (attr (attr (data) \"prices\" -1) \"sum\" -1) (attr (attr (data) \"volumes\" -1) \"sum\" -1) -1) -1))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": -1, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided for XTZ-USD", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": -1}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1595104530) -1) (tuple (literal (timestamp 1595104531) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 1) -1) (tuple (literal (intOrNat 2) -1) (tuple (literal (intOrNat 3) -1) (literal (intOrNat 4) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Normalizes_One_Data_Point", "longname": "Normalizes One Data Point", "scenario": [{"action": "html", "tag": "h1", "inner": "Normalizes One Data Point", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract.", "line_no": -1}, {"action": "newContract", "id": 0, "export": "(storage (record -1 (assetCode (literal (string \"XTZ-USD\") -1)) (computedPrice (literal (intOrNat 0) -1)) (lastUpdateTime (literal (timestamp 0) -1)) (numDataPoints (literal (int 3) 137)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)) (prices (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))) (volumes (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))))\nstorage_type (())\nmessages ((get True ((set (operations -1) (cons (transfer (attr (data) \"computedPrice\" -1) (literal (mutez 0) -1) (params 137) -1) (operations -1) -1) -1))) (update True ((set_type (params 137) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1) (verify (eq (sender) (attr (data) \"oracleContract\" -1) -1) False (literal (string \"Can only be called by the oracle contract.\") -1) -1) (defineLocal \"compute_-1\" (getItem (params 137) (attr (data) \"assetCode\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (verify (gt (getLocal \"compute_-1\" -1) (attr (data) \"lastUpdateTime\" -1) -1) False -1) (set (attr (data) \"lastUpdateTime\" -1) (getLocal \"compute_-1\" -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"last\" -1) (add (attr (attr (data) \"prices\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (add (attr (attr (data) \"prices\" -1) \"sum\" -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) -1) (set (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"last\" -1) (add (attr (attr (data) \"volumes\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (add (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getLocal \"compute_-1\" -1) -1) -1) (set (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) (getLocal \"compute_-1\" -1) -1) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" -1) \"last\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (literal (intOrNat 1) -1) -1) (attr (data) \"numDataPoints\" -1) -1) ((verify (lt (attr (attr (data) \"prices\" -1) \"first\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"prices\" -1) \"sum\" -1) (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (set (attr (attr (data) \"prices\" -1) \"first\" -1) (add (attr (attr (data) \"prices\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1) (verify (lt (attr (attr (data) \"volumes\" -1) \"first\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) (set (attr (attr (data) \"volumes\" -1) \"first\" -1) (add (attr (attr (data) \"volumes\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1)) -1) (set (attr (data) \"computedPrice\" -1) (truediv (attr (attr (data) \"prices\" -1) \"sum\" -1) (attr (attr (data) \"volumes\" -1) \"sum\" -1) -1) -1))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": -1, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided", "line_no": -1}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1595104530) -1) (tuple (literal (timestamp 1595104531) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 1) -1) (tuple (literal (intOrNat 2) -1) (tuple (literal (intOrNat 3) -1) (literal (intOrNat 4) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the ComputedPrice is the VWAP.", "line_no": -1}, {"action": "verify", "condition": "(eq (attr (contractData 0 -1) \"computedPrice\" -1) (literal (intOrNat 2) -1) -1)", "line_no": -1}]}, {"shortname": "Normalizes_Three_Data_Points", "longname": "Normalizes Three Data Points", "scenario": [{"action": "html", "tag": "h1", "inner": "Normalizes Three Data Points", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract", "line_no": -1}, {"action": "newContract", "id": 0, "export": "(storage (record -1 (assetCode (literal (string \"XTZ-USD\") -1)) (computedPrice (literal (intOrNat 0) -1)) (lastUpdateTime (literal (timestamp 0) -1)) (numDataPoints (literal (int 3) 137)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)) (prices (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))) (volumes (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))))\nstorage_type (())\nmessages ((get True ((set (operations -1) (cons (transfer (attr (data) \"computedPrice\" -1) (literal (mutez 0) -1) (params 137) -1) (operations -1) -1) -1))) (update True ((set_type (params 137) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1) (verify (eq (sender) (attr (data) \"oracleContract\" -1) -1) False (literal (string \"Can only be called by the oracle contract.\") -1) -1) (defineLocal \"compute_-1\" (getItem (params 137) (attr (data) \"assetCode\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (verify (gt (getLocal \"compute_-1\" -1) (attr (data) \"lastUpdateTime\" -1) -1) False -1) (set (attr (data) \"lastUpdateTime\" -1) (getLocal \"compute_-1\" -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"last\" -1) (add (attr (attr (data) \"prices\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (add (attr (attr (data) \"prices\" -1) \"sum\" -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) -1) (set (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"last\" -1) (add (attr (attr (data) \"volumes\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (add (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getLocal \"compute_-1\" -1) -1) -1) (set (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) (getLocal \"compute_-1\" -1) -1) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" -1) \"last\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (literal (intOrNat 1) -1) -1) (attr (data) \"numDataPoints\" -1) -1) ((verify (lt (attr (attr (data) \"prices\" -1) \"first\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"prices\" -1) \"sum\" -1) (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (set (attr (attr (data) \"prices\" -1) \"first\" -1) (add (attr (attr (data) \"prices\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1) (verify (lt (attr (attr (data) \"volumes\" -1) \"first\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) (set (attr (attr (data) \"volumes\" -1) \"first\" -1) (add (attr (attr (data) \"volumes\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1)) -1) (set (attr (data) \"computedPrice\" -1) (truediv (attr (attr (data) \"prices\" -1) \"sum\" -1) (attr (attr (data) \"volumes\" -1) \"sum\" -1) -1) -1))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": -1, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN three updates are provided", "line_no": -1}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1595104530) -1) (tuple (literal (timestamp 1595104531) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 1) -1) (tuple (literal (intOrNat 2) -1) (tuple (literal (intOrNat 3) -1) (literal (intOrNat 4) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1595104532) -1) (tuple (literal (timestamp 1595104533) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 5) -1) (tuple (literal (intOrNat 6) -1) (tuple (literal (intOrNat 7) -1) (literal (intOrNat 8) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1595104534) -1) (tuple (literal (timestamp 1595104535) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 9) -1) (tuple (literal (intOrNat 10) -1) (tuple (literal (intOrNat 11) -1) (literal (intOrNat 12) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "WHEN the ComputedPrice is the VWAP of the updates", "line_no": -1}, {"action": "verify", "condition": "(eq (attr (contractData 0 -1) \"computedPrice\" -1) (literal (intOrNat 7) -1) -1)", "line_no": -1}]}, {"shortname": "Bounds_computation_to_the_number_of_data_points", "longname": "Bounds computation to the number of data points", "scenario": [{"action": "html", "tag": "h1", "inner": "Bounds computation to the number of data points", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract set to only hold two data points", "line_no": -1}, {"action": "newContract", "id": 0, "export": "(storage (record -1 (assetCode (literal (string \"XTZ-USD\") -1)) (computedPrice (literal (intOrNat 0) -1)) (lastUpdateTime (literal (timestamp 0) -1)) (numDataPoints (literal (intOrNat 2) -1)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)) (prices (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))) (volumes (record -1 (first (literal (intOrNat 0) -1)) (last (literal (int -1) -1)) (saved (map -1 ((literal (intOrNat 0) -1) (literal (nat 0) -1)))) (sum (literal (nat 0) -1)))))\nstorage_type (())\nmessages ((get True ((set (operations -1) (cons (transfer (attr (data) \"computedPrice\" -1) (literal (mutez 0) -1) (params 137) -1) (operations -1) -1) -1))) (update True ((set_type (params 137) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1) (verify (eq (sender) (attr (data) \"oracleContract\" -1) -1) False (literal (string \"Can only be called by the oracle contract.\") -1) -1) (defineLocal \"compute_-1\" (getItem (params 137) (attr (data) \"assetCode\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (verify (gt (getLocal \"compute_-1\" -1) (attr (data) \"lastUpdateTime\" -1) -1) False -1) (set (attr (data) \"lastUpdateTime\" -1) (getLocal \"compute_-1\" -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (first (getLocal \"compute_-1\" -1) -1) -1) (defineLocal \"compute_-1\" (second (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"last\" -1) (add (attr (attr (data) \"prices\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (add (attr (attr (data) \"prices\" -1) \"sum\" -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) -1) (set (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) (mul (truediv (add (add (getLocal \"compute_-1\" -1) (getLocal \"compute_-1\" -1) -1) (getLocal \"compute_-1\" -1) -1) (literal (intOrNat 3) -1) -1) (getLocal \"compute_-1\" -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"last\" -1) (add (attr (attr (data) \"volumes\" -1) \"last\" -1) (literal (intOrNat 1) -1) -1) -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (add (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getLocal \"compute_-1\" -1) -1) -1) (set (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) (getLocal \"compute_-1\" -1) -1) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" -1) \"last\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (literal (intOrNat 1) -1) -1) (attr (data) \"numDataPoints\" -1) -1) ((verify (lt (attr (attr (data) \"prices\" -1) \"first\" -1) (attr (attr (data) \"prices\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"prices\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"prices\" -1) \"sum\" -1) (getItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"prices\" -1) \"saved\" -1) (attr (attr (data) \"prices\" -1) \"first\" -1) -1) (set (attr (attr (data) \"prices\" -1) \"first\" -1) (add (attr (attr (data) \"prices\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1) (verify (lt (attr (attr (data) \"volumes\" -1) \"first\" -1) (attr (attr (data) \"volumes\" -1) \"last\" -1) -1) False -1) (set (attr (attr (data) \"volumes\" -1) \"sum\" -1) (openVariant (isNat (sub (attr (attr (data) \"volumes\" -1) \"sum\" -1) (getItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) -1) -1) \"Some\" -1) -1) (delItem (attr (attr (data) \"volumes\" -1) \"saved\" -1) (attr (attr (data) \"volumes\" -1) \"first\" -1) -1) (set (attr (attr (data) \"volumes\" -1) \"first\" -1) (add (attr (attr (data) \"volumes\" -1) \"first\" -1) (literal (intOrNat 1) -1) -1) -1)) -1) (set (attr (data) \"computedPrice\" -1) (truediv (attr (attr (data) \"prices\" -1) \"sum\" -1) (attr (attr (data) \"volumes\" -1) \"sum\" -1) -1) -1))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": -1, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN three updates are provided", "line_no": -1}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1595104530) -1) (tuple (literal (timestamp 1595104531) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 1) -1) (tuple (literal (intOrNat 2) -1) (tuple (literal (intOrNat 3) -1) (literal (intOrNat 4) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1595104532) -1) (tuple (literal (timestamp 1595104533) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 5) -1) (tuple (literal (intOrNat 6) -1) (tuple (literal (intOrNat 7) -1) (literal (intOrNat 8) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map -1 ((literal (string \"XTZ-USD\") -1) (tuple (literal (timestamp 1595104534) -1) (tuple (literal (timestamp 1595104535) -1) (tuple (literal (intOrNat 3059701) -1) (tuple (literal (intOrNat 9) -1) (tuple (literal (intOrNat 10) -1) (tuple (literal (intOrNat 11) -1) (literal (intOrNat 12) -1) -1) -1) -1) -1) -1) -1))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) -1)", "line_no": -1, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 137)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the contract is only tracking two updates", "line_no": -1}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (contractData 0 -1) \"prices\" -1) \"last\" -1) (attr (attr (contractData 0 -1) \"prices\" -1) \"first\" -1) -1) (literal (intOrNat 1) -1) -1) (literal (intOrNat 2) -1) -1)", "line_no": -1}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (contractData 0 -1) \"volumes\" -1) \"last\" -1) (attr (attr (contractData 0 -1) \"volumes\" -1) \"first\" -1) -1) (literal (intOrNat 1) -1) -1) (literal (intOrNat 2) -1) -1)", "line_no": -1}, {"action": "html", "tag": "h2", "inner": "AND the computed price is the VWAP of the latter two updates", "line_no": -1}, {"action": "verify", "condition": "(eq (attr (contractData 0 -1) \"computedPrice\" -1) (literal (intOrNat 8) -1) -1)", "line_no": -1}]}, {"shortname": "Update_Once_With_Valid_Data", "longname": "Update Once With Valid Data", "scenario": [{"action": "html", "tag": "h1", "inner": "Update Once With Valid Data", "line_no": 143}, {"action": "html", "tag": "h2", "inner": "GIVEN an Oracle contract", "line_no": 145}, {"action": "newContract", "id": 0, "export": "(storage (record 57 (oracleData (type_annotation (big_map 52 ((literal (string \"XTZ-USD\") 149) (tuple (literal (timestamp 0) 49) (tuple (literal (timestamp 0) 49) (tuple (literal (intOrNat 0) 149) (tuple (literal (intOrNat 0) 149) (tuple (literal (intOrNat 0) 149) (tuple (literal (intOrNat 0) 149) (literal (intOrNat 0) 149) 149) 149) 149) 149) 149) 149))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 52)) (publicKey (variant \"Some\" (reduce (attr (account_of_seed \"Test1\" 829) \"public_key\" 829) 829) 830)))\nstorage_type (())\nmessages ((push True ((set (operations 129) (cons (transfer (attr (data) \"oracleData\" 129) (literal (mutez 0) 129) (params 127) 129) (operations 129) 129) 129))) (revoke True ((verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (params 111) (pack (type_annotation (variant \"None\" (unit) -1) (option \"key\") 114) 115) 119) False 119) (set (attr (data) \"publicKey\" 118) (variant \"None\" (unit) -1) 122))) (update True ((forGroup \"assetData\" (items (params 69) 72) ((verify (contains (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 81) \"Oracle does not track asset\" 82) (verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (first (attr (iter \"assetData\" 73) \"value\" 76) 76) (pack (tuple (attr (iter \"assetData\" 73) \"key\" 75) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 86) 86) 89) \"Bad signature\" 90) (verify (gt (first (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 96) (first (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 94) 95) 97) \"Update in past\" 97) (set (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 100) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 100)) 73))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 149, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "AND an update", "line_no": 151}, {"action": "html", "tag": "h2", "inner": "WHEN the oracle is updated", "line_no": 174}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (map 181 ((literal (string \"XTZ-USD\") 183) (tuple (reduce (make_signature (reduce (attr (account_of_seed \"Test1\" 829) \"secret_key\" 829) 829) (pack (tuple (literal (string \"XTZ-USD\") 167) (tuple (literal (timestamp 1) 153) (tuple (literal (timestamp 2) 154) (tuple (literal (intOrNat 3) 167) (tuple (literal (intOrNat 4) 167) (tuple (literal (intOrNat 5) 167) (tuple (literal (intOrNat 6) 167) (literal (intOrNat 7) 167) 167) 167) 167) 167) 167) 167) 167) 167) \"Raw\" 171) 171) (tuple (literal (timestamp 1) 153) (tuple (literal (timestamp 2) 154) (tuple (literal (intOrNat 3) 183) (tuple (literal (intOrNat 4) 183) (tuple (literal (intOrNat 5) 183) (tuple (literal (intOrNat 6) 183) (literal (intOrNat 7) 183) 183) 183) 183) 183) 183) 183) 175))) (map \"string\" (pair \"signature\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\")))))))) 181)", "line_no": 183, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the oracle contains the data points", "line_no": 185}, {"action": "verify", "condition": "(eq (literal (timestamp 1) 153) (first (getItem (attr (contractData 0 183) \"oracleData\" 186) (literal (string \"XTZ-USD\") 186) 186) 193) 201)", "line_no": 201}, {"action": "verify", "condition": "(eq (literal (timestamp 2) 154) (first (second (getItem (attr (contractData 0 183) \"oracleData\" 186) (literal (string \"XTZ-USD\") 186) 186) 187) 194) 202)", "line_no": 202}, {"action": "verify", "condition": "(eq (first (second (second (getItem (attr (contractData 0 183) \"oracleData\" 186) (literal (string \"XTZ-USD\") 186) 186) 187) 188) 195) (literal (intOrNat 3) 203) 203)", "line_no": 203}, {"action": "verify", "condition": "(eq (first (second (second (second (getItem (attr (contractData 0 183) \"oracleData\" 186) (literal (string \"XTZ-USD\") 186) 186) 187) 188) 189) 196) (literal (intOrNat 4) 204) 204)", "line_no": 204}, {"action": "verify", "condition": "(eq (first (second (second (second (second (getItem (attr (contractData 0 183) \"oracleData\" 186) (literal (string \"XTZ-USD\") 186) 186) 187) 188) 189) 190) 197) (literal (intOrNat 5) 205) 205)", "line_no": 205}, {"action": "verify", "condition": "(eq (first (second (second (second (second (second (getItem (attr (contractData 0 183) \"oracleData\" 186) (literal (string \"XTZ-USD\") 186) 186) 187) 188) 189) 190) 191) 198) (literal (intOrNat 6) 206) 206)", "line_no": 206}, {"action": "verify", "condition": "(eq (second (second (second (second (second (second (getItem (attr (contractData 0 183) \"oracleData\" 186) (literal (string \"XTZ-USD\") 186) 186) 187) 188) 189) 190) 191) 199) (literal (intOrNat 7) 207) 207)", "line_no": 207}]}, {"shortname": "Second_Update_Overwrites_First_Update", "longname": "Second Update Overwrites First Update", "scenario": [{"action": "html", "tag": "h1", "inner": "Second Update Overwrites First Update", "line_no": 277}, {"action": "html", "tag": "h2", "inner": "GIVEN an Oracle contract", "line_no": 279}, {"action": "newContract", "id": 0, "export": "(storage (record 57 (oracleData (type_annotation (big_map 288 ((literal (string \"XTZ-USD\") 291) (tuple (literal (timestamp 0) 835) (tuple (literal (timestamp 0) 837) (tuple (literal (intOrNat 0) 291) (tuple (literal (intOrNat 0) 291) (tuple (literal (intOrNat 0) 291) (tuple (literal (intOrNat 0) 291) (literal (intOrNat 0) 291) 291) 291) 291) 291) 291) 291))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 288)) (publicKey (variant \"Some\" (reduce (attr (account_of_seed \"Test1\" 829) \"public_key\" 829) 829) 830)))\nstorage_type (())\nmessages ((push True ((set (operations 129) (cons (transfer (attr (data) \"oracleData\" 129) (literal (mutez 0) 129) (params 127) 129) (operations 129) 129) 129))) (revoke True ((verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (params 111) (pack (type_annotation (variant \"None\" (unit) -1) (option \"key\") 114) 115) 119) False 119) (set (attr (data) \"publicKey\" 118) (variant \"None\" (unit) -1) 122))) (update True ((forGroup \"assetData\" (items (params 69) 72) ((verify (contains (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 81) \"Oracle does not track asset\" 82) (verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (first (attr (iter \"assetData\" 73) \"value\" 76) 76) (pack (tuple (attr (iter \"assetData\" 73) \"key\" 75) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 86) 86) 89) \"Bad signature\" 90) (verify (gt (first (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 96) (first (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 94) 95) 97) \"Update in past\" 97) (set (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 100) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 100)) 73))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 291, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "AND two updates", "line_no": 293}, {"action": "html", "tag": "h2", "inner": "WHEN the oracle is updated", "line_no": 336}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (map 344 ((literal (string \"XTZ-USD\") 353) (tuple (reduce (make_signature (reduce (attr (account_of_seed \"Test1\" 829) \"secret_key\" 829) 829) (pack (tuple (literal (string \"XTZ-USD\") 308) (tuple (literal (timestamp 1) 294) (tuple (literal (timestamp 2) 295) (tuple (literal (intOrNat 3) 308) (tuple (literal (intOrNat 4) 308) (tuple (literal (intOrNat 5) 308) (tuple (literal (intOrNat 6) 308) (literal (intOrNat 7) 308) 308) 308) 308) 308) 308) 308) 308) 308) \"Raw\" 312) 312) (tuple (literal (timestamp 1) 294) (tuple (literal (timestamp 2) 295) (tuple (literal (intOrNat 3) 353) (tuple (literal (intOrNat 4) 353) (tuple (literal (intOrNat 5) 353) (tuple (literal (intOrNat 6) 353) (literal (intOrNat 7) 353) 353) 353) 353) 353) 353) 353) 337))) (map \"string\" (pair \"signature\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\")))))))) 344)", "line_no": 353, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (map 351 ((literal (string \"XTZ-USD\") 354) (tuple (reduce (make_signature (reduce (attr (account_of_seed \"Test1\" 829) \"secret_key\" 829) 829) (pack (tuple (literal (string \"XTZ-USD\") 329) (tuple (literal (timestamp 8) 315) (tuple (literal (timestamp 9) 316) (tuple (literal (intOrNat 10) 329) (tuple (literal (intOrNat 11) 329) (tuple (literal (intOrNat 12) 329) (tuple (literal (intOrNat 13) 329) (literal (intOrNat 14) 329) 329) 329) 329) 329) 329) 329) 329) 329) \"Raw\" 333) 333) (tuple (literal (timestamp 8) 315) (tuple (literal (timestamp 9) 316) (tuple (literal (intOrNat 10) 354) (tuple (literal (intOrNat 11) 354) (tuple (literal (intOrNat 12) 354) (tuple (literal (intOrNat 13) 354) (literal (intOrNat 14) 354) 354) 354) 354) 354) 354) 354) 338))) (map \"string\" (pair \"signature\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\")))))))) 351)", "line_no": 354, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the oracle contains the data points of the latter update", "line_no": 356}, {"action": "verify", "condition": "(eq (first (getItem (attr (contractData 0 354) \"oracleData\" 357) (literal (string \"XTZ-USD\") 357) 357) 364) (literal (timestamp 8) 315) 372)", "line_no": 372}, {"action": "verify", "condition": "(eq (first (second (getItem (attr (contractData 0 354) \"oracleData\" 357) (literal (string \"XTZ-USD\") 357) 357) 358) 365) (literal (timestamp 9) 316) 373)", "line_no": 373}, {"action": "verify", "condition": "(eq (first (second (second (getItem (attr (contractData 0 354) \"oracleData\" 357) (literal (string \"XTZ-USD\") 357) 357) 358) 359) 366) (literal (intOrNat 10) 374) 374)", "line_no": 374}, {"action": "verify", "condition": "(eq (first (second (second (second (getItem (attr (contractData 0 354) \"oracleData\" 357) (literal (string \"XTZ-USD\") 357) 357) 358) 359) 360) 367) (literal (intOrNat 11) 375) 375)", "line_no": 375}, {"action": "verify", "condition": "(eq (first (second (second (second (second (getItem (attr (contractData 0 354) \"oracleData\" 357) (literal (string \"XTZ-USD\") 357) 357) 358) 359) 360) 361) 368) (literal (intOrNat 12) 376) 376)", "line_no": 376}, {"action": "verify", "condition": "(eq (first (second (second (second (second (second (getItem (attr (contractData 0 354) \"oracleData\" 357) (literal (string \"XTZ-USD\") 357) 357) 358) 359) 360) 361) 362) 369) (literal (intOrNat 13) 377) 377)", "line_no": 377}, {"action": "verify", "condition": "(eq (second (second (second (second (second (second (getItem (attr (contractData 0 354) \"oracleData\" 357) (literal (string \"XTZ-USD\") 357) 357) 358) 359) 360) 361) 362) 370) (literal (intOrNat 14) 378) 378)", "line_no": 378}]}, {"shortname": "Update_Fails_With_Data_From_The_Same_Timestamp", "longname": "Update Fails With Data From The Same Timestamp", "scenario": [{"action": "html", "tag": "h1", "inner": "Update Fails With Data From The Same Timestamp", "line_no": 384}, {"action": "html", "tag": "h2", "inner": "GIVEN an Oracle contract", "line_no": 386}, {"action": "newContract", "id": 0, "export": "(storage (record 57 (oracleData (type_annotation (big_map 395 ((literal (string \"XTZ-USD\") 398) (tuple (literal (timestamp 0) 835) (tuple (literal (timestamp 0) 837) (tuple (literal (intOrNat 0) 398) (tuple (literal (intOrNat 0) 398) (tuple (literal (intOrNat 0) 398) (tuple (literal (intOrNat 0) 398) (literal (intOrNat 0) 398) 398) 398) 398) 398) 398) 398))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 395)) (publicKey (variant \"Some\" (reduce (attr (account_of_seed \"Test1\" 829) \"public_key\" 829) 829) 830)))\nstorage_type (())\nmessages ((push True ((set (operations 129) (cons (transfer (attr (data) \"oracleData\" 129) (literal (mutez 0) 129) (params 127) 129) (operations 129) 129) 129))) (revoke True ((verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (params 111) (pack (type_annotation (variant \"None\" (unit) -1) (option \"key\") 114) 115) 119) False 119) (set (attr (data) \"publicKey\" 118) (variant \"None\" (unit) -1) 122))) (update True ((forGroup \"assetData\" (items (params 69) 72) ((verify (contains (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 81) \"Oracle does not track asset\" 82) (verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (first (attr (iter \"assetData\" 73) \"value\" 76) 76) (pack (tuple (attr (iter \"assetData\" 73) \"key\" 75) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 86) 86) 89) \"Bad signature\" 90) (verify (gt (first (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 96) (first (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 94) 95) 97) \"Update in past\" 97) (set (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 100) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 100)) 73))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 398, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "AND an update", "line_no": 400}, {"action": "html", "tag": "h2", "inner": "WHEN the oracle is updated twice", "line_no": 422}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (map 429 ((literal (string \"XTZ-USD\") 431) (tuple (reduce (make_signature (reduce (attr (account_of_seed \"Test1\" 829) \"secret_key\" 829) 829) (pack (tuple (literal (string \"XTZ-USD\") 415) (tuple (literal (timestamp 1) 401) (tuple (literal (timestamp 2) 402) (tuple (literal (intOrNat 3) 415) (tuple (literal (intOrNat 4) 415) (tuple (literal (intOrNat 5) 415) (tuple (literal (intOrNat 6) 415) (literal (intOrNat 7) 415) 415) 415) 415) 415) 415) 415) 415) 415) \"Raw\" 419) 419) (tuple (literal (timestamp 1) 401) (tuple (literal (timestamp 2) 402) (tuple (literal (intOrNat 3) 431) (tuple (literal (intOrNat 4) 431) (tuple (literal (intOrNat 5) 431) (tuple (literal (intOrNat 6) 431) (literal (intOrNat 7) 431) 431) 431) 431) 431) 431) 431) 423))) (map \"string\" (pair \"signature\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\")))))))) 429)", "line_no": 431, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the second update fails", "line_no": 433}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (map 429 ((literal (string \"XTZ-USD\") 434) (tuple (reduce (make_signature (reduce (attr (account_of_seed \"Test1\" 829) \"secret_key\" 829) 829) (pack (tuple (literal (string \"XTZ-USD\") 415) (tuple (literal (timestamp 1) 401) (tuple (literal (timestamp 2) 402) (tuple (literal (intOrNat 3) 415) (tuple (literal (intOrNat 4) 415) (tuple (literal (intOrNat 5) 415) (tuple (literal (intOrNat 6) 415) (literal (intOrNat 7) 415) 415) 415) 415) 415) 415) 415) 415) 415) \"Raw\" 419) 419) (tuple (literal (timestamp 1) 401) (tuple (literal (timestamp 2) 402) (tuple (literal (intOrNat 3) 434) (tuple (literal (intOrNat 4) 434) (tuple (literal (intOrNat 5) 434) (tuple (literal (intOrNat 6) 434) (literal (intOrNat 7) 434) 434) 434) 434) 434) 434) 434) 423))) (map \"string\" (pair \"signature\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\")))))))) 429)", "line_no": 434, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Update_Fails_With_Data_From_The_Past", "longname": "Update Fails With Data From The Past", "scenario": [{"action": "html", "tag": "h1", "inner": "Update Fails With Data From The Past", "line_no": 440}, {"action": "html", "tag": "h2", "inner": "GIVEN an Oracle contract with some initial data.", "line_no": 442}, {"action": "newContract", "id": 0, "export": "(storage (record 57 (oracleData (type_annotation (big_map 452 ((literal (string \"XTZ-USD\") 455) (tuple (literal (timestamp 0) 835) (tuple (literal (timestamp 0) 837) (tuple (literal (intOrNat 0) 455) (tuple (literal (intOrNat 0) 455) (tuple (literal (intOrNat 0) 455) (tuple (literal (intOrNat 0) 455) (literal (intOrNat 0) 455) 455) 455) 455) 455) 455) 455))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 452)) (publicKey (variant \"Some\" (reduce (attr (account_of_seed \"Test1\" 829) \"public_key\" 829) 829) 830)))\nstorage_type (())\nmessages ((push True ((set (operations 129) (cons (transfer (attr (data) \"oracleData\" 129) (literal (mutez 0) 129) (params 127) 129) (operations 129) 129) 129))) (revoke True ((verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (params 111) (pack (type_annotation (variant \"None\" (unit) -1) (option \"key\") 114) 115) 119) False 119) (set (attr (data) \"publicKey\" 118) (variant \"None\" (unit) -1) 122))) (update True ((forGroup \"assetData\" (items (params 69) 72) ((verify (contains (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 81) \"Oracle does not track asset\" 82) (verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (first (attr (iter \"assetData\" 73) \"value\" 76) 76) (pack (tuple (attr (iter \"assetData\" 73) \"key\" 75) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 86) 86) 89) \"Bad signature\" 90) (verify (gt (first (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 96) (first (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 94) 95) 97) \"Update in past\" 97) (set (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 100) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 100)) 73))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 455, "show": true, "accept_unknown_types": false}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (map 484 ((literal (string \"XTZ-USD\") 486) (tuple (reduce (make_signature (reduce (attr (account_of_seed \"Test1\" 829) \"secret_key\" 829) 829) (pack (tuple (literal (string \"XTZ-USD\") 471) (tuple (literal (timestamp 2) 457) (tuple (literal (timestamp 3) 458) (tuple (literal (intOrNat 3) 471) (tuple (literal (intOrNat 4) 471) (tuple (literal (intOrNat 5) 471) (tuple (literal (intOrNat 6) 471) (literal (intOrNat 7) 471) 471) 471) 471) 471) 471) 471) 471) 471) \"Raw\" 475) 475) (tuple (literal (timestamp 2) 457) (tuple (literal (timestamp 3) 458) (tuple (literal (intOrNat 3) 486) (tuple (literal (intOrNat 4) 486) (tuple (literal (intOrNat 5) 486) (tuple (literal (intOrNat 6) 486) (literal (intOrNat 7) 486) 486) 486) 486) 486) 486) 486) 478))) (map \"string\" (pair \"signature\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\")))))))) 484)", "line_no": 486, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "WHEN the oracle is updated with a time in the past", "line_no": 488}, {"action": "html", "tag": "h2", "inner": "THEN the update in the past fails", "line_no": 512}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (map 509 ((literal (string \"XTZ-USD\") 513) (tuple (reduce (make_signature (reduce (attr (account_of_seed \"Test1\" 829) \"secret_key\" 829) 829) (pack (tuple (literal (timestamp 1) 490) (tuple (literal (timestamp 2) 491) (tuple (literal (intOrNat 3) 496) (tuple (literal (intOrNat 4) 496) (tuple (literal (intOrNat 5) 496) (tuple (literal (intOrNat 6) 496) (literal (intOrNat 7) 496) 496) 496) 496) 496) 496) 496) 496) \"Raw\" 500) 500) (tuple (literal (timestamp 1) 490) (tuple (literal (timestamp 2) 491) (tuple (literal (intOrNat 3) 513) (tuple (literal (intOrNat 4) 513) (tuple (literal (intOrNat 5) 513) (tuple (literal (intOrNat 6) 513) (literal (intOrNat 7) 513) 513) 513) 513) 513) 513) 513) 503))) (map \"string\" (pair \"signature\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\")))))))) 509)", "line_no": 513, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Update_Fails_With_Untracked_Asset", "longname": "Update Fails With Untracked Asset", "scenario": [{"action": "html", "tag": "h1", "inner": "Update Fails With Untracked Asset", "line_no": 519}, {"action": "html", "tag": "h2", "inner": "GIVEN an Oracle contract", "line_no": 521}, {"action": "newContract", "id": 0, "export": "(storage (record 57 (oracleData (type_annotation (big_map 531 ((literal (string \"XTZ-USD\") 534) (tuple (literal (timestamp 0) 835) (tuple (literal (timestamp 0) 837) (tuple (literal (intOrNat 0) 534) (tuple (literal (intOrNat 0) 534) (tuple (literal (intOrNat 0) 534) (tuple (literal (intOrNat 0) 534) (literal (intOrNat 0) 534) 534) 534) 534) 534) 534) 534))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 531)) (publicKey (variant \"Some\" (reduce (attr (account_of_seed \"Test1\" 829) \"public_key\" 829) 829) 830)))\nstorage_type (())\nmessages ((push True ((set (operations 129) (cons (transfer (attr (data) \"oracleData\" 129) (literal (mutez 0) 129) (params 127) 129) (operations 129) 129) 129))) (revoke True ((verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (params 111) (pack (type_annotation (variant \"None\" (unit) -1) (option \"key\") 114) 115) 119) False 119) (set (attr (data) \"publicKey\" 118) (variant \"None\" (unit) -1) 122))) (update True ((forGroup \"assetData\" (items (params 69) 72) ((verify (contains (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 81) \"Oracle does not track asset\" 82) (verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (first (attr (iter \"assetData\" 73) \"value\" 76) 76) (pack (tuple (attr (iter \"assetData\" 73) \"key\" 75) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 86) 86) 89) \"Bad signature\" 90) (verify (gt (first (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 96) (first (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 94) 95) 97) \"Update in past\" 97) (set (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 100) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 100)) 73))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 534, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN the oracle is updated with an untracked asset", "line_no": 557}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": 567}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (map 564 ((literal (string \"BTC-USD\") 568) (tuple (reduce (make_signature (reduce (attr (account_of_seed \"Test1\" 829) \"secret_key\" 829) 829) (pack (tuple (literal (string \"XTZ-USD\") 550) (tuple (literal (timestamp 2) 536) (tuple (literal (timestamp 3) 537) (tuple (literal (intOrNat 3) 550) (tuple (literal (intOrNat 4) 550) (tuple (literal (intOrNat 5) 550) (tuple (literal (intOrNat 6) 550) (literal (intOrNat 7) 550) 550) 550) 550) 550) 550) 550) 550) 550) \"Raw\" 554) 554) (tuple (literal (timestamp 2) 536) (tuple (literal (timestamp 3) 537) (tuple (literal (intOrNat 3) 568) (tuple (literal (intOrNat 4) 568) (tuple (literal (intOrNat 5) 568) (tuple (literal (intOrNat 6) 568) (literal (intOrNat 7) 568) 568) 568) 568) 568) 568) 568) 558))) (map \"string\" (pair \"signature\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\")))))))) 564)", "line_no": 568, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Update_Fails_With_Bad_Signature", "longname": "Update Fails With Bad Signature", "scenario": [{"action": "html", "tag": "h1", "inner": "Update Fails With Bad Signature", "line_no": 574}, {"action": "html", "tag": "h2", "inner": "GIVEN an Oracle contract", "line_no": 576}, {"action": "newContract", "id": 0, "export": "(storage (record 57 (oracleData (type_annotation (big_map 586 ((literal (string \"XTZ-USD\") 589) (tuple (literal (timestamp 0) 835) (tuple (literal (timestamp 0) 837) (tuple (literal (intOrNat 0) 589) (tuple (literal (intOrNat 0) 589) (tuple (literal (intOrNat 0) 589) (tuple (literal (intOrNat 0) 589) (literal (intOrNat 0) 589) 589) 589) 589) 589) 589) 589))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 586)) (publicKey (variant \"Some\" (reduce (attr (account_of_seed \"Test1\" 829) \"public_key\" 829) 829) 830)))\nstorage_type (())\nmessages ((push True ((set (operations 129) (cons (transfer (attr (data) \"oracleData\" 129) (literal (mutez 0) 129) (params 127) 129) (operations 129) 129) 129))) (revoke True ((verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (params 111) (pack (type_annotation (variant \"None\" (unit) -1) (option \"key\") 114) 115) 119) False 119) (set (attr (data) \"publicKey\" 118) (variant \"None\" (unit) -1) 122))) (update True ((forGroup \"assetData\" (items (params 69) 72) ((verify (contains (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 81) \"Oracle does not track asset\" 82) (verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (first (attr (iter \"assetData\" 73) \"value\" 76) 76) (pack (tuple (attr (iter \"assetData\" 73) \"key\" 75) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 86) 86) 89) \"Bad signature\" 90) (verify (gt (first (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 96) (first (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 94) 95) 97) \"Update in past\" 97) (set (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 100) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 100)) 73))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 589, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "AND an update signed by an alternative key", "line_no": 591}, {"action": "html", "tag": "h2", "inner": "WHEN the oracle is updated", "line_no": 615}, {"action": "html", "tag": "h2", "inner": "THEN the update fails", "line_no": 625}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (map 622 ((literal (string \"XTZ-USD\") 626) (tuple (reduce (make_signature (reduce (attr (account_of_seed \"AlternativeAccount\" 592) \"secret_key\" 592) 592) (pack (tuple (literal (timestamp 1) 594) (tuple (literal (timestamp 2) 595) (tuple (literal (intOrNat 3) 608) (tuple (literal (intOrNat 4) 608) (tuple (literal (intOrNat 5) 608) (tuple (literal (intOrNat 6) 608) (literal (intOrNat 7) 608) 608) 608) 608) 608) 608) 608) 608) \"Raw\" 612) 612) (tuple (literal (timestamp 1) 594) (tuple (literal (timestamp 2) 595) (tuple (literal (intOrNat 3) 626) (tuple (literal (intOrNat 4) 626) (tuple (literal (intOrNat 5) 626) (tuple (literal (intOrNat 6) 626) (literal (intOrNat 7) 626) 626) 626) 626) 626) 626) 626) 616))) (map \"string\" (pair \"signature\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\")))))))) 622)", "line_no": 626, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Revokes_An_Oracle", "longname": "Revokes An Oracle", "scenario": [{"action": "html", "tag": "h1", "inner": "Revokes An Oracle", "line_no": 632}, {"action": "html", "tag": "h2", "inner": "GIVEN an oracle contract and a correctly signed revoke message.", "line_no": 635}, {"action": "newContract", "id": 0, "export": "(storage (record 57 (oracleData (type_annotation (big_map 651 ((literal (string \"XTZ-USD\") 654) (tuple (literal (timestamp 0) 835) (tuple (literal (timestamp 0) 837) (tuple (literal (intOrNat 0) 654) (tuple (literal (intOrNat 0) 654) (tuple (literal (intOrNat 0) 654) (tuple (literal (intOrNat 0) 654) (literal (intOrNat 0) 654) 654) 654) 654) 654) 654) 654))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 651)) (publicKey (variant \"Some\" (reduce (attr (account_of_seed \"Test1\" 829) \"public_key\" 829) 829) 830)))\nstorage_type (())\nmessages ((push True ((set (operations 129) (cons (transfer (attr (data) \"oracleData\" 129) (literal (mutez 0) 129) (params 127) 129) (operations 129) 129) 129))) (revoke True ((verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (params 111) (pack (type_annotation (variant \"None\" (unit) -1) (option \"key\") 114) 115) 119) False 119) (set (attr (data) \"publicKey\" 118) (variant \"None\" (unit) -1) 122))) (update True ((forGroup \"assetData\" (items (params 69) 72) ((verify (contains (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 81) \"Oracle does not track asset\" 82) (verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (first (attr (iter \"assetData\" 73) \"value\" 76) 76) (pack (tuple (attr (iter \"assetData\" 73) \"key\" 75) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 86) 86) 89) \"Bad signature\" 90) (verify (gt (first (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 96) (first (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 94) 95) 97) \"Update in past\" 97) (set (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 100) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 100)) 73))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 654, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN revoke is called.", "line_no": 656}, {"action": "message", "id": 0, "message": "revoke", "params": "(reduce (make_signature (reduce (attr (account_of_seed \"Test1\" 829) \"secret_key\" 829) 829) (pack (variant \"None\" (unit) -1) 636) \"Raw\" 640) 640)", "line_no": 657, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the oracle is revoked", "line_no": 659}, {"action": "verify", "condition": "(invert (isVariant (attr (contractData 0 657) \"publicKey\" 660) \"Some\" 660) 660)", "line_no": 660}, {"action": "html", "tag": "h2", "inner": "AND future updates fail.", "line_no": 662}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (map 690 ((literal (string \"XTZ-USD\") 692) (tuple (reduce (make_signature (reduce (attr (account_of_seed \"Test1\" 829) \"secret_key\" 829) 829) (pack (tuple (literal (string \"XTZ-USD\") 677) (tuple (literal (timestamp 1) 663) (tuple (literal (timestamp 2) 664) (tuple (literal (intOrNat 3) 677) (tuple (literal (intOrNat 4) 677) (tuple (literal (intOrNat 5) 677) (tuple (literal (intOrNat 6) 677) (literal (intOrNat 7) 677) 677) 677) 677) 677) 677) 677) 677) 677) \"Raw\" 681) 681) (tuple (literal (timestamp 1) 663) (tuple (literal (timestamp 2) 664) (tuple (literal (intOrNat 3) 692) (tuple (literal (intOrNat 4) 692) (tuple (literal (intOrNat 5) 692) (tuple (literal (intOrNat 6) 692) (literal (intOrNat 7) 692) 692) 692) 692) 692) 692) 692) 684))) (map \"string\" (pair \"signature\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\")))))))) 690)", "line_no": 692, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Incorrect_Revoke_Fails_to_Revoke_An_Oracle", "longname": "Incorrect Revoke Fails to Revoke An Oracle", "scenario": [{"action": "html", "tag": "h1", "inner": "Incorrect Revoke Fails to Revoke An Oracle", "line_no": 698}, {"action": "html", "tag": "h2", "inner": "GIVEN an oracle contract and a revoke message signed by another account.", "line_no": 701}, {"action": "newContract", "id": 0, "export": "(storage (record 57 (oracleData (type_annotation (big_map 718 ((literal (string \"XTZ-USD\") 721) (tuple (literal (timestamp 0) 835) (tuple (literal (timestamp 0) 837) (tuple (literal (intOrNat 0) 721) (tuple (literal (intOrNat 0) 721) (tuple (literal (intOrNat 0) 721) (tuple (literal (intOrNat 0) 721) (literal (intOrNat 0) 721) 721) 721) 721) 721) 721) 721))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 718)) (publicKey (variant \"Some\" (reduce (attr (account_of_seed \"Test1\" 829) \"public_key\" 829) 829) 830)))\nstorage_type (())\nmessages ((push True ((set (operations 129) (cons (transfer (attr (data) \"oracleData\" 129) (literal (mutez 0) 129) (params 127) 129) (operations 129) 129) 129))) (revoke True ((verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (params 111) (pack (type_annotation (variant \"None\" (unit) -1) (option \"key\") 114) 115) 119) False 119) (set (attr (data) \"publicKey\" 118) (variant \"None\" (unit) -1) 122))) (update True ((forGroup \"assetData\" (items (params 69) 72) ((verify (contains (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 81) \"Oracle does not track asset\" 82) (verify (check_signature (openVariant (attr (data) \"publicKey\" 118) \"Some\" 118) (first (attr (iter \"assetData\" 73) \"value\" 76) 76) (pack (tuple (attr (iter \"assetData\" 73) \"key\" 75) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 86) 86) 89) \"Bad signature\" 90) (verify (gt (first (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 96) (first (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 94) 95) 97) \"Update in past\" 97) (set (getItem (attr (data) \"oracleData\" 129) (attr (iter \"assetData\" 73) \"key\" 75) 100) (second (attr (iter \"assetData\" 73) \"value\" 76) 77) 100)) 73))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 721, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN revoke is called", "line_no": 723}, {"action": "html", "tag": "h2", "inner": "THEN the call fails", "line_no": 724}, {"action": "message", "id": 0, "message": "revoke", "params": "(reduce (make_signature (reduce (attr (account_of_seed \"Incorrect_Account\" 702) \"secret_key\" 702) 702) (pack (variant \"None\" (unit) -1) 703) \"Raw\" 707) 707)", "line_no": 725, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}, {"action": "html", "tag": "h2", "inner": "AND future updates succeed", "line_no": 727}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (map 755 ((literal (string \"XTZ-USD\") 757) (tuple (reduce (make_signature (reduce (attr (account_of_seed \"Test1\" 829) \"secret_key\" 829) 829) (pack (tuple (literal (string \"XTZ-USD\") 742) (tuple (literal (timestamp 1) 728) (tuple (literal (timestamp 2) 729) (tuple (literal (intOrNat 3) 742) (tuple (literal (intOrNat 4) 742) (tuple (literal (intOrNat 5) 742) (tuple (literal (intOrNat 6) 742) (literal (intOrNat 7) 742) 742) 742) 742) 742) 742) 742) 742) 742) \"Raw\" 746) 746) (tuple (literal (timestamp 1) 728) (tuple (literal (timestamp 2) 729) (tuple (literal (intOrNat 3) 757) (tuple (literal (intOrNat 4) 757) (tuple (literal (intOrNat 5) 757) (tuple (literal (intOrNat 6) 757) (literal (intOrNat 7) 757) 757) 757) 757) 757) 757) 757) 749))) (map \"string\" (pair \"signature\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\")))))))) 755)", "line_no": 757, "title": "", "messageClass": "", "source": "none", "sender": "none", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}]}]