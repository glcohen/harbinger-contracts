[{"shortname": "Fails_with_bad_contract_data", "longname": "Fails with bad contract data", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails when data is pushed from bad address", "line_no": 130}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract whitelisted to an address", "line_no": 132}, {"action": "newContract", "id": 0, "export": "(storage (record 52 (assetCode (literal (string \"XTZ-USD\") 52)) (computedPrice (literal (intOrNat 0) 52)) (lastUpdateTime (literal (timestamp 0) 44)) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)) (prices (record 40 (first (literal (intOrNat 0) 40)) (last (literal (int -1) 40)) (saved (map 40 ((literal (intOrNat 0) 136) (literal (nat 0) 40)))) (sum (literal (nat 0) 40)))) (volumes (record 41 (first (literal (intOrNat 0) 41)) (last (literal (int -1) 41)) (saved (map 41 ((literal (intOrNat 0) 136) (literal (nat 0) 41)))) (sum (literal (nat 0) 41)))))\nstorage_type (())\nmessages ((get True ((set (operations 121) (cons (transfer (attr (data) \"computedPrice\" 121) (literal (mutez 0) 121) (params 119) 121) (operations 121) 121) 121))) (update True ((set_type (params 64) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 66) (verify (eq (sender) (attr (data) \"oracleContract\" 70) 70) False (literal (string \"bad sender\") 71) 71) (defineLocal \"compute_75\" (getItem (params 64) (attr (data) \"assetCode\" 75) 75) 75) (defineLocal \"compute_78\" (first (getLocal \"compute_75\" 75) 78) 78) (verify (gt (getLocal \"compute_78\" 78) (attr (data) \"lastUpdateTime\" 79) 79) False 79) (set (attr (data) \"lastUpdateTime\" 79) (getLocal \"compute_78\" 78) 82) (defineLocal \"compute_85\" (second (getLocal \"compute_75\" 75) 85) 85) (defineLocal \"compute_86\" (second (getLocal \"compute_85\" 85) 86) 86) (defineLocal \"compute_87\" (second (getLocal \"compute_86\" 86) 87) 87) (defineLocal \"compute_88\" (second (getLocal \"compute_87\" 87) 88) 88) (defineLocal \"compute_89\" (second (getLocal \"compute_88\" 88) 89) 89) (defineLocal \"compute_93\" (first (getLocal \"compute_87\" 87) 93) 93) (defineLocal \"compute_94\" (first (getLocal \"compute_88\" 88) 94) 94) (defineLocal \"compute_95\" (first (getLocal \"compute_89\" 89) 95) 95) (defineLocal \"compute_96\" (second (getLocal \"compute_89\" 89) 96) 96) (set (attr (attr (data) \"prices\" 100) \"last\" 100) (add (attr (attr (data) \"prices\" 100) \"last\" 100) (literal (intOrNat 1) 100) 100) 100) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (add (attr (attr (data) \"prices\" 100) \"sum\" 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) 100) (set (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"last\" 100) 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) (set (attr (attr (data) \"volumes\" 101) \"last\" 101) (add (attr (attr (data) \"volumes\" 101) \"last\" 101) (literal (intOrNat 1) 101) 101) 101) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (add (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getLocal \"compute_96\" 96) 101) 101) (set (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"last\" 101) 101) (getLocal \"compute_96\" 96) 101) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" 100) \"last\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 104) (literal (intOrNat 1) 104) 104) (attr (data) \"numDataPoints\" 104) 104) ((verify (lt (attr (attr (data) \"prices\" 100) \"first\" 104) (attr (attr (data) \"prices\" 100) \"last\" 100) 105) False 105) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (openVariant (isNat (sub (attr (attr (data) \"prices\" 100) \"sum\" 100) (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) 105) 105) \"Some\" 105) 105) (delItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) (set (attr (attr (data) \"prices\" 100) \"first\" 104) (add (attr (attr (data) \"prices\" 100) \"first\" 104) (literal (intOrNat 1) 105) 105) 105) (verify (lt (attr (attr (data) \"volumes\" 101) \"first\" 106) (attr (attr (data) \"volumes\" 101) \"last\" 101) 106) False 106) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (openVariant (isNat (sub (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) 106) 106) \"Some\" 106) 106) (delItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) (set (attr (attr (data) \"volumes\" 101) \"first\" 106) (add (attr (attr (data) \"volumes\" 101) \"first\" 106) (literal (intOrNat 1) 106) 106) 106)) 104) (set (attr (data) \"computedPrice\" 121) (truediv (attr (attr (data) \"prices\" 100) \"sum\" 100) (attr (attr (data) \"volumes\" 101) \"sum\" 101) 109) 109))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 136, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN an update is pushed from the wrong address", "line_no": 138}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": 139}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 152) (tuple (literal (timestamp 1595104501) 144) (tuple (literal (timestamp 1595104531) 145) (tuple (literal (intOrNat 3059701) 152) (tuple (literal (intOrNat 1) 152) (tuple (literal (intOrNat 2) 152) (tuple (literal (intOrNat 3) 152) (literal (intOrNat 4) 152) 152) 152) 152) 152) 152) 152))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 150, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1FrRkunqmB7futF3EyRwTt8f7fPEVJW39P\") 140)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Fails_with_updates_from_the_same_time", "longname": "Fails with updates from the same time", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails with updates from the past", "line_no": 157}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract with an update at a given time = 1", "line_no": 159}, {"action": "newContract", "id": 0, "export": "(storage (record 52 (assetCode (literal (string \"XTZ-USD\") 52)) (computedPrice (literal (intOrNat 0) 52)) (lastUpdateTime (literal (timestamp 0) 44)) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 36)) (prices (record 40 (first (literal (intOrNat 0) 40)) (last (literal (int -1) 40)) (saved (map 40 ((literal (intOrNat 0) 162) (literal (nat 0) 40)))) (sum (literal (nat 0) 40)))) (volumes (record 41 (first (literal (intOrNat 0) 41)) (last (literal (int -1) 41)) (saved (map 41 ((literal (intOrNat 0) 162) (literal (nat 0) 41)))) (sum (literal (nat 0) 41)))))\nstorage_type (())\nmessages ((get True ((set (operations 121) (cons (transfer (attr (data) \"computedPrice\" 121) (literal (mutez 0) 121) (params 119) 121) (operations 121) 121) 121))) (update True ((set_type (params 64) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 66) (verify (eq (sender) (attr (data) \"oracleContract\" 70) 70) False (literal (string \"bad sender\") 71) 71) (defineLocal \"compute_75\" (getItem (params 64) (attr (data) \"assetCode\" 75) 75) 75) (defineLocal \"compute_78\" (first (getLocal \"compute_75\" 75) 78) 78) (verify (gt (getLocal \"compute_78\" 78) (attr (data) \"lastUpdateTime\" 79) 79) False 79) (set (attr (data) \"lastUpdateTime\" 79) (getLocal \"compute_78\" 78) 82) (defineLocal \"compute_85\" (second (getLocal \"compute_75\" 75) 85) 85) (defineLocal \"compute_86\" (second (getLocal \"compute_85\" 85) 86) 86) (defineLocal \"compute_87\" (second (getLocal \"compute_86\" 86) 87) 87) (defineLocal \"compute_88\" (second (getLocal \"compute_87\" 87) 88) 88) (defineLocal \"compute_89\" (second (getLocal \"compute_88\" 88) 89) 89) (defineLocal \"compute_93\" (first (getLocal \"compute_87\" 87) 93) 93) (defineLocal \"compute_94\" (first (getLocal \"compute_88\" 88) 94) 94) (defineLocal \"compute_95\" (first (getLocal \"compute_89\" 89) 95) 95) (defineLocal \"compute_96\" (second (getLocal \"compute_89\" 89) 96) 96) (set (attr (attr (data) \"prices\" 100) \"last\" 100) (add (attr (attr (data) \"prices\" 100) \"last\" 100) (literal (intOrNat 1) 100) 100) 100) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (add (attr (attr (data) \"prices\" 100) \"sum\" 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) 100) (set (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"last\" 100) 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) (set (attr (attr (data) \"volumes\" 101) \"last\" 101) (add (attr (attr (data) \"volumes\" 101) \"last\" 101) (literal (intOrNat 1) 101) 101) 101) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (add (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getLocal \"compute_96\" 96) 101) 101) (set (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"last\" 101) 101) (getLocal \"compute_96\" 96) 101) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" 100) \"last\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 104) (literal (intOrNat 1) 104) 104) (attr (data) \"numDataPoints\" 104) 104) ((verify (lt (attr (attr (data) \"prices\" 100) \"first\" 104) (attr (attr (data) \"prices\" 100) \"last\" 100) 105) False 105) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (openVariant (isNat (sub (attr (attr (data) \"prices\" 100) \"sum\" 100) (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) 105) 105) \"Some\" 105) 105) (delItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) (set (attr (attr (data) \"prices\" 100) \"first\" 104) (add (attr (attr (data) \"prices\" 100) \"first\" 104) (literal (intOrNat 1) 105) 105) 105) (verify (lt (attr (attr (data) \"volumes\" 101) \"first\" 106) (attr (attr (data) \"volumes\" 101) \"last\" 101) 106) False 106) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (openVariant (isNat (sub (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) 106) 106) \"Some\" 106) 106) (delItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) (set (attr (attr (data) \"volumes\" 101) \"first\" 106) (add (attr (attr (data) \"volumes\" 101) \"first\" 106) (literal (intOrNat 1) 106) 106) 106)) 104) (set (attr (data) \"computedPrice\" 121) (truediv (attr (attr (data) \"prices\" 100) \"sum\" 100) (attr (attr (data) \"volumes\" 101) \"sum\" 101) 109) 109))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 162, "show": true, "accept_unknown_types": false}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 174) (tuple (literal (timestamp 1) 160) (tuple (literal (timestamp 1595104531) 167) (tuple (literal (intOrNat 3059701) 174) (tuple (literal (intOrNat 1) 174) (tuple (literal (intOrNat 2) 174) (tuple (literal (intOrNat 3) 174) (literal (intOrNat 4) 174) 174) 174) 174) 174) 174) 174))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 172, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided at the same time.", "line_no": 176}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": 177}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 189) (tuple (literal (timestamp 1) 160) (tuple (literal (timestamp 1595104531) 182) (tuple (literal (intOrNat 3059701) 189) (tuple (literal (intOrNat 1) 189) (tuple (literal (intOrNat 2) 189) (tuple (literal (intOrNat 3) 189) (literal (intOrNat 4) 189) 189) 189) 189) 189) 189) 189))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 187, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Fails_with_updates_from_the_past_time", "longname": "Fails with updates from the past time", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails with updates from the past", "line_no": 194}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract with an update at a current time and a time in the past", "line_no": 197}, {"action": "newContract", "id": 0, "export": "(storage (record 52 (assetCode (literal (string \"XTZ-USD\") 52)) (computedPrice (literal (intOrNat 0) 52)) (lastUpdateTime (literal (timestamp 0) 44)) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 36)) (prices (record 40 (first (literal (intOrNat 0) 40)) (last (literal (int -1) 40)) (saved (map 40 ((literal (intOrNat 0) 201) (literal (nat 0) 40)))) (sum (literal (nat 0) 40)))) (volumes (record 41 (first (literal (intOrNat 0) 41)) (last (literal (int -1) 41)) (saved (map 41 ((literal (intOrNat 0) 201) (literal (nat 0) 41)))) (sum (literal (nat 0) 41)))))\nstorage_type (())\nmessages ((get True ((set (operations 121) (cons (transfer (attr (data) \"computedPrice\" 121) (literal (mutez 0) 121) (params 119) 121) (operations 121) 121) 121))) (update True ((set_type (params 64) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 66) (verify (eq (sender) (attr (data) \"oracleContract\" 70) 70) False (literal (string \"bad sender\") 71) 71) (defineLocal \"compute_75\" (getItem (params 64) (attr (data) \"assetCode\" 75) 75) 75) (defineLocal \"compute_78\" (first (getLocal \"compute_75\" 75) 78) 78) (verify (gt (getLocal \"compute_78\" 78) (attr (data) \"lastUpdateTime\" 79) 79) False 79) (set (attr (data) \"lastUpdateTime\" 79) (getLocal \"compute_78\" 78) 82) (defineLocal \"compute_85\" (second (getLocal \"compute_75\" 75) 85) 85) (defineLocal \"compute_86\" (second (getLocal \"compute_85\" 85) 86) 86) (defineLocal \"compute_87\" (second (getLocal \"compute_86\" 86) 87) 87) (defineLocal \"compute_88\" (second (getLocal \"compute_87\" 87) 88) 88) (defineLocal \"compute_89\" (second (getLocal \"compute_88\" 88) 89) 89) (defineLocal \"compute_93\" (first (getLocal \"compute_87\" 87) 93) 93) (defineLocal \"compute_94\" (first (getLocal \"compute_88\" 88) 94) 94) (defineLocal \"compute_95\" (first (getLocal \"compute_89\" 89) 95) 95) (defineLocal \"compute_96\" (second (getLocal \"compute_89\" 89) 96) 96) (set (attr (attr (data) \"prices\" 100) \"last\" 100) (add (attr (attr (data) \"prices\" 100) \"last\" 100) (literal (intOrNat 1) 100) 100) 100) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (add (attr (attr (data) \"prices\" 100) \"sum\" 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) 100) (set (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"last\" 100) 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) (set (attr (attr (data) \"volumes\" 101) \"last\" 101) (add (attr (attr (data) \"volumes\" 101) \"last\" 101) (literal (intOrNat 1) 101) 101) 101) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (add (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getLocal \"compute_96\" 96) 101) 101) (set (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"last\" 101) 101) (getLocal \"compute_96\" 96) 101) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" 100) \"last\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 104) (literal (intOrNat 1) 104) 104) (attr (data) \"numDataPoints\" 104) 104) ((verify (lt (attr (attr (data) \"prices\" 100) \"first\" 104) (attr (attr (data) \"prices\" 100) \"last\" 100) 105) False 105) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (openVariant (isNat (sub (attr (attr (data) \"prices\" 100) \"sum\" 100) (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) 105) 105) \"Some\" 105) 105) (delItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) (set (attr (attr (data) \"prices\" 100) \"first\" 104) (add (attr (attr (data) \"prices\" 100) \"first\" 104) (literal (intOrNat 1) 105) 105) 105) (verify (lt (attr (attr (data) \"volumes\" 101) \"first\" 106) (attr (attr (data) \"volumes\" 101) \"last\" 101) 106) False 106) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (openVariant (isNat (sub (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) 106) 106) \"Some\" 106) 106) (delItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) (set (attr (attr (data) \"volumes\" 101) \"first\" 106) (add (attr (attr (data) \"volumes\" 101) \"first\" 106) (literal (intOrNat 1) 106) 106) 106)) 104) (set (attr (data) \"computedPrice\" 121) (truediv (attr (attr (data) \"prices\" 100) \"sum\" 100) (attr (attr (data) \"volumes\" 101) \"sum\" 101) 109) 109))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 201, "show": true, "accept_unknown_types": false}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 213) (tuple (literal (timestamp 2) 198) (tuple (literal (timestamp 1595104531) 206) (tuple (literal (intOrNat 3059701) 213) (tuple (literal (intOrNat 1) 213) (tuple (literal (intOrNat 2) 213) (tuple (literal (intOrNat 3) 213) (literal (intOrNat 4) 213) 213) 213) 213) 213) 213) 213))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 211, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided from the past.", "line_no": 215}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": 216}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 228) (tuple (literal (timestamp 1) 199) (tuple (literal (timestamp 1595104531) 221) (tuple (literal (intOrNat 3059701) 228) (tuple (literal (intOrNat 1) 228) (tuple (literal (intOrNat 2) 228) (tuple (literal (intOrNat 3) 228) (literal (intOrNat 4) 228) 228) 228) 228) 228) 228) 228))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 226, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Fails_with_updates_for_the_wrong_asset", "longname": "Fails with updates for the wrong asset", "scenario": [{"action": "html", "tag": "h1", "inner": "Fails with updates from the wrong asset", "line_no": 234}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract for the bitcoin price", "line_no": 236}, {"action": "newContract", "id": 0, "export": "(storage (record 52 (assetCode (literal (string \"BTC-USD\") 52)) (computedPrice (literal (intOrNat 0) 52)) (lastUpdateTime (literal (timestamp 0) 44)) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 36)) (prices (record 40 (first (literal (intOrNat 0) 40)) (last (literal (int -1) 40)) (saved (map 40 ((literal (intOrNat 0) 238) (literal (nat 0) 40)))) (sum (literal (nat 0) 40)))) (volumes (record 41 (first (literal (intOrNat 0) 41)) (last (literal (int -1) 41)) (saved (map 41 ((literal (intOrNat 0) 238) (literal (nat 0) 41)))) (sum (literal (nat 0) 41)))))\nstorage_type (())\nmessages ((get True ((set (operations 121) (cons (transfer (attr (data) \"computedPrice\" 121) (literal (mutez 0) 121) (params 119) 121) (operations 121) 121) 121))) (update True ((set_type (params 64) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 66) (verify (eq (sender) (attr (data) \"oracleContract\" 70) 70) False (literal (string \"bad sender\") 71) 71) (defineLocal \"compute_75\" (getItem (params 64) (attr (data) \"assetCode\" 75) 75) 75) (defineLocal \"compute_78\" (first (getLocal \"compute_75\" 75) 78) 78) (verify (gt (getLocal \"compute_78\" 78) (attr (data) \"lastUpdateTime\" 79) 79) False 79) (set (attr (data) \"lastUpdateTime\" 79) (getLocal \"compute_78\" 78) 82) (defineLocal \"compute_85\" (second (getLocal \"compute_75\" 75) 85) 85) (defineLocal \"compute_86\" (second (getLocal \"compute_85\" 85) 86) 86) (defineLocal \"compute_87\" (second (getLocal \"compute_86\" 86) 87) 87) (defineLocal \"compute_88\" (second (getLocal \"compute_87\" 87) 88) 88) (defineLocal \"compute_89\" (second (getLocal \"compute_88\" 88) 89) 89) (defineLocal \"compute_93\" (first (getLocal \"compute_87\" 87) 93) 93) (defineLocal \"compute_94\" (first (getLocal \"compute_88\" 88) 94) 94) (defineLocal \"compute_95\" (first (getLocal \"compute_89\" 89) 95) 95) (defineLocal \"compute_96\" (second (getLocal \"compute_89\" 89) 96) 96) (set (attr (attr (data) \"prices\" 100) \"last\" 100) (add (attr (attr (data) \"prices\" 100) \"last\" 100) (literal (intOrNat 1) 100) 100) 100) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (add (attr (attr (data) \"prices\" 100) \"sum\" 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) 100) (set (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"last\" 100) 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) (set (attr (attr (data) \"volumes\" 101) \"last\" 101) (add (attr (attr (data) \"volumes\" 101) \"last\" 101) (literal (intOrNat 1) 101) 101) 101) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (add (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getLocal \"compute_96\" 96) 101) 101) (set (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"last\" 101) 101) (getLocal \"compute_96\" 96) 101) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" 100) \"last\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 104) (literal (intOrNat 1) 104) 104) (attr (data) \"numDataPoints\" 104) 104) ((verify (lt (attr (attr (data) \"prices\" 100) \"first\" 104) (attr (attr (data) \"prices\" 100) \"last\" 100) 105) False 105) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (openVariant (isNat (sub (attr (attr (data) \"prices\" 100) \"sum\" 100) (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) 105) 105) \"Some\" 105) 105) (delItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) (set (attr (attr (data) \"prices\" 100) \"first\" 104) (add (attr (attr (data) \"prices\" 100) \"first\" 104) (literal (intOrNat 1) 105) 105) 105) (verify (lt (attr (attr (data) \"volumes\" 101) \"first\" 106) (attr (attr (data) \"volumes\" 101) \"last\" 101) 106) False 106) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (openVariant (isNat (sub (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) 106) 106) \"Some\" 106) 106) (delItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) (set (attr (attr (data) \"volumes\" 101) \"first\" 106) (add (attr (attr (data) \"volumes\" 101) \"first\" 106) (literal (intOrNat 1) 106) 106) 106)) 104) (set (attr (data) \"computedPrice\" 121) (truediv (attr (attr (data) \"prices\" 100) \"sum\" 100) (attr (attr (data) \"volumes\" 101) \"sum\" 101) 109) 109))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 238, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided for XTZ-USD", "line_no": 240}, {"action": "html", "tag": "h2", "inner": "THEN the update fails.", "line_no": 241}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 253) (tuple (literal (timestamp 1595104530) 245) (tuple (literal (timestamp 1595104531) 246) (tuple (literal (intOrNat 3059701) 253) (tuple (literal (intOrNat 1) 253) (tuple (literal (intOrNat 2) 253) (tuple (literal (intOrNat 3) 253) (literal (intOrNat 4) 253) 253) 253) 253) 253) 253) 253))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 251, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": false}]}, {"shortname": "Normalizes_One_Data_Point", "longname": "Normalizes One Data Point", "scenario": [{"action": "html", "tag": "h1", "inner": "Normalizes One Data Point", "line_no": 258}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract.", "line_no": 260}, {"action": "newContract", "id": 0, "export": "(storage (record 52 (assetCode (literal (string \"XTZ-USD\") 52)) (computedPrice (literal (intOrNat 0) 52)) (lastUpdateTime (literal (timestamp 0) 44)) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 36)) (prices (record 40 (first (literal (intOrNat 0) 40)) (last (literal (int -1) 40)) (saved (map 40 ((literal (intOrNat 0) 262) (literal (nat 0) 40)))) (sum (literal (nat 0) 40)))) (volumes (record 41 (first (literal (intOrNat 0) 41)) (last (literal (int -1) 41)) (saved (map 41 ((literal (intOrNat 0) 262) (literal (nat 0) 41)))) (sum (literal (nat 0) 41)))))\nstorage_type (())\nmessages ((get True ((set (operations 121) (cons (transfer (attr (data) \"computedPrice\" 121) (literal (mutez 0) 121) (params 119) 121) (operations 121) 121) 121))) (update True ((set_type (params 64) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 66) (verify (eq (sender) (attr (data) \"oracleContract\" 70) 70) False (literal (string \"bad sender\") 71) 71) (defineLocal \"compute_75\" (getItem (params 64) (attr (data) \"assetCode\" 75) 75) 75) (defineLocal \"compute_78\" (first (getLocal \"compute_75\" 75) 78) 78) (verify (gt (getLocal \"compute_78\" 78) (attr (data) \"lastUpdateTime\" 79) 79) False 79) (set (attr (data) \"lastUpdateTime\" 79) (getLocal \"compute_78\" 78) 82) (defineLocal \"compute_85\" (second (getLocal \"compute_75\" 75) 85) 85) (defineLocal \"compute_86\" (second (getLocal \"compute_85\" 85) 86) 86) (defineLocal \"compute_87\" (second (getLocal \"compute_86\" 86) 87) 87) (defineLocal \"compute_88\" (second (getLocal \"compute_87\" 87) 88) 88) (defineLocal \"compute_89\" (second (getLocal \"compute_88\" 88) 89) 89) (defineLocal \"compute_93\" (first (getLocal \"compute_87\" 87) 93) 93) (defineLocal \"compute_94\" (first (getLocal \"compute_88\" 88) 94) 94) (defineLocal \"compute_95\" (first (getLocal \"compute_89\" 89) 95) 95) (defineLocal \"compute_96\" (second (getLocal \"compute_89\" 89) 96) 96) (set (attr (attr (data) \"prices\" 100) \"last\" 100) (add (attr (attr (data) \"prices\" 100) \"last\" 100) (literal (intOrNat 1) 100) 100) 100) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (add (attr (attr (data) \"prices\" 100) \"sum\" 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) 100) (set (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"last\" 100) 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) (set (attr (attr (data) \"volumes\" 101) \"last\" 101) (add (attr (attr (data) \"volumes\" 101) \"last\" 101) (literal (intOrNat 1) 101) 101) 101) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (add (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getLocal \"compute_96\" 96) 101) 101) (set (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"last\" 101) 101) (getLocal \"compute_96\" 96) 101) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" 100) \"last\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 104) (literal (intOrNat 1) 104) 104) (attr (data) \"numDataPoints\" 104) 104) ((verify (lt (attr (attr (data) \"prices\" 100) \"first\" 104) (attr (attr (data) \"prices\" 100) \"last\" 100) 105) False 105) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (openVariant (isNat (sub (attr (attr (data) \"prices\" 100) \"sum\" 100) (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) 105) 105) \"Some\" 105) 105) (delItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) (set (attr (attr (data) \"prices\" 100) \"first\" 104) (add (attr (attr (data) \"prices\" 100) \"first\" 104) (literal (intOrNat 1) 105) 105) 105) (verify (lt (attr (attr (data) \"volumes\" 101) \"first\" 106) (attr (attr (data) \"volumes\" 101) \"last\" 101) 106) False 106) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (openVariant (isNat (sub (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) 106) 106) \"Some\" 106) 106) (delItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) (set (attr (attr (data) \"volumes\" 101) \"first\" 106) (add (attr (attr (data) \"volumes\" 101) \"first\" 106) (literal (intOrNat 1) 106) 106) 106)) 104) (set (attr (data) \"computedPrice\" 121) (truediv (attr (attr (data) \"prices\" 100) \"sum\" 100) (attr (attr (data) \"volumes\" 101) \"sum\" 101) 109) 109))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 262, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN an update is provided", "line_no": 269}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 281) (tuple (literal (timestamp 1595104530) 273) (tuple (literal (timestamp 1595104531) 274) (tuple (literal (intOrNat 3059701) 281) (tuple (literal (intOrNat 1) 281) (tuple (literal (intOrNat 2) 281) (tuple (literal (intOrNat 3) 281) (literal (intOrNat 4) 281) 281) 281) 281) 281) 281) 281))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 279, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the ComputedPrice is the VWAP.", "line_no": 283}, {"action": "verify", "condition": "(eq (attr (contractData 0 281) \"computedPrice\" 290) (literal (intOrNat 2) 290) 290)", "line_no": 290}]}, {"shortname": "Normalizes_Three_Data_Points", "longname": "Normalizes Three Data Points", "scenario": [{"action": "html", "tag": "h1", "inner": "Normalizes Three Data Points", "line_no": 295}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract", "line_no": 297}, {"action": "newContract", "id": 0, "export": "(storage (record 52 (assetCode (literal (string \"XTZ-USD\") 52)) (computedPrice (literal (intOrNat 0) 52)) (lastUpdateTime (literal (timestamp 0) 44)) (numDataPoints (literal (int 3) 37)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 36)) (prices (record 40 (first (literal (intOrNat 0) 40)) (last (literal (int -1) 40)) (saved (map 40 ((literal (intOrNat 0) 299) (literal (nat 0) 40)))) (sum (literal (nat 0) 40)))) (volumes (record 41 (first (literal (intOrNat 0) 41)) (last (literal (int -1) 41)) (saved (map 41 ((literal (intOrNat 0) 299) (literal (nat 0) 41)))) (sum (literal (nat 0) 41)))))\nstorage_type (())\nmessages ((get True ((set (operations 121) (cons (transfer (attr (data) \"computedPrice\" 121) (literal (mutez 0) 121) (params 119) 121) (operations 121) 121) 121))) (update True ((set_type (params 64) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 66) (verify (eq (sender) (attr (data) \"oracleContract\" 70) 70) False (literal (string \"bad sender\") 71) 71) (defineLocal \"compute_75\" (getItem (params 64) (attr (data) \"assetCode\" 75) 75) 75) (defineLocal \"compute_78\" (first (getLocal \"compute_75\" 75) 78) 78) (verify (gt (getLocal \"compute_78\" 78) (attr (data) \"lastUpdateTime\" 79) 79) False 79) (set (attr (data) \"lastUpdateTime\" 79) (getLocal \"compute_78\" 78) 82) (defineLocal \"compute_85\" (second (getLocal \"compute_75\" 75) 85) 85) (defineLocal \"compute_86\" (second (getLocal \"compute_85\" 85) 86) 86) (defineLocal \"compute_87\" (second (getLocal \"compute_86\" 86) 87) 87) (defineLocal \"compute_88\" (second (getLocal \"compute_87\" 87) 88) 88) (defineLocal \"compute_89\" (second (getLocal \"compute_88\" 88) 89) 89) (defineLocal \"compute_93\" (first (getLocal \"compute_87\" 87) 93) 93) (defineLocal \"compute_94\" (first (getLocal \"compute_88\" 88) 94) 94) (defineLocal \"compute_95\" (first (getLocal \"compute_89\" 89) 95) 95) (defineLocal \"compute_96\" (second (getLocal \"compute_89\" 89) 96) 96) (set (attr (attr (data) \"prices\" 100) \"last\" 100) (add (attr (attr (data) \"prices\" 100) \"last\" 100) (literal (intOrNat 1) 100) 100) 100) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (add (attr (attr (data) \"prices\" 100) \"sum\" 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) 100) (set (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"last\" 100) 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) (set (attr (attr (data) \"volumes\" 101) \"last\" 101) (add (attr (attr (data) \"volumes\" 101) \"last\" 101) (literal (intOrNat 1) 101) 101) 101) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (add (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getLocal \"compute_96\" 96) 101) 101) (set (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"last\" 101) 101) (getLocal \"compute_96\" 96) 101) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" 100) \"last\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 104) (literal (intOrNat 1) 104) 104) (attr (data) \"numDataPoints\" 104) 104) ((verify (lt (attr (attr (data) \"prices\" 100) \"first\" 104) (attr (attr (data) \"prices\" 100) \"last\" 100) 105) False 105) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (openVariant (isNat (sub (attr (attr (data) \"prices\" 100) \"sum\" 100) (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) 105) 105) \"Some\" 105) 105) (delItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) (set (attr (attr (data) \"prices\" 100) \"first\" 104) (add (attr (attr (data) \"prices\" 100) \"first\" 104) (literal (intOrNat 1) 105) 105) 105) (verify (lt (attr (attr (data) \"volumes\" 101) \"first\" 106) (attr (attr (data) \"volumes\" 101) \"last\" 101) 106) False 106) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (openVariant (isNat (sub (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) 106) 106) \"Some\" 106) 106) (delItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) (set (attr (attr (data) \"volumes\" 101) \"first\" 106) (add (attr (attr (data) \"volumes\" 101) \"first\" 106) (literal (intOrNat 1) 106) 106) 106)) 104) (set (attr (data) \"computedPrice\" 121) (truediv (attr (attr (data) \"prices\" 100) \"sum\" 100) (attr (attr (data) \"volumes\" 101) \"sum\" 101) 109) 109))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 299, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN three updates are provided", "line_no": 301}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 317) (tuple (literal (timestamp 1595104530) 309) (tuple (literal (timestamp 1595104531) 310) (tuple (literal (intOrNat 3059701) 317) (tuple (literal (intOrNat 1) 317) (tuple (literal (intOrNat 2) 317) (tuple (literal (intOrNat 3) 317) (literal (intOrNat 4) 317) 317) 317) 317) 317) 317) 317))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 315, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 334) (tuple (literal (timestamp 1595104532) 326) (tuple (literal (timestamp 1595104533) 327) (tuple (literal (intOrNat 3059701) 334) (tuple (literal (intOrNat 5) 334) (tuple (literal (intOrNat 6) 334) (tuple (literal (intOrNat 7) 334) (literal (intOrNat 8) 334) 334) 334) 334) 334) 334) 334))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 332, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 351) (tuple (literal (timestamp 1595104534) 343) (tuple (literal (timestamp 1595104535) 344) (tuple (literal (intOrNat 3059701) 351) (tuple (literal (intOrNat 9) 351) (tuple (literal (intOrNat 10) 351) (tuple (literal (intOrNat 11) 351) (literal (intOrNat 12) 351) 351) 351) 351) 351) 351) 351))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 349, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "WHEN the ComputedPrice is the VWAP of the updates", "line_no": 353}, {"action": "verify", "condition": "(eq (attr (contractData 0 351) \"computedPrice\" 375) (literal (intOrNat 7) 375) 375)", "line_no": 375}]}, {"shortname": "Bounds_computation_to_the_number_of_data_points", "longname": "Bounds computation to the number of data points", "scenario": [{"action": "html", "tag": "h1", "inner": "Bounds computation to the number of data points", "line_no": 381}, {"action": "html", "tag": "h2", "inner": "GIVEN a Normalizer contract set to only hold two data points", "line_no": 383}, {"action": "newContract", "id": 0, "export": "(storage (record 52 (assetCode (literal (string \"XTZ-USD\") 52)) (computedPrice (literal (intOrNat 0) 52)) (lastUpdateTime (literal (timestamp 0) 44)) (numDataPoints (literal (intOrNat 2) 52)) (oracleContract (literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 36)) (prices (record 40 (first (literal (intOrNat 0) 40)) (last (literal (int -1) 40)) (saved (map 40 ((literal (intOrNat 0) 386) (literal (nat 0) 40)))) (sum (literal (nat 0) 40)))) (volumes (record 41 (first (literal (intOrNat 0) 41)) (last (literal (int -1) 41)) (saved (map 41 ((literal (intOrNat 0) 386) (literal (nat 0) 41)))) (sum (literal (nat 0) 41)))))\nstorage_type (())\nmessages ((get True ((set (operations 121) (cons (transfer (attr (data) \"computedPrice\" 121) (literal (mutez 0) 121) (params 119) 121) (operations 121) 121) 121))) (update True ((set_type (params 64) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 66) (verify (eq (sender) (attr (data) \"oracleContract\" 70) 70) False (literal (string \"bad sender\") 71) 71) (defineLocal \"compute_75\" (getItem (params 64) (attr (data) \"assetCode\" 75) 75) 75) (defineLocal \"compute_78\" (first (getLocal \"compute_75\" 75) 78) 78) (verify (gt (getLocal \"compute_78\" 78) (attr (data) \"lastUpdateTime\" 79) 79) False 79) (set (attr (data) \"lastUpdateTime\" 79) (getLocal \"compute_78\" 78) 82) (defineLocal \"compute_85\" (second (getLocal \"compute_75\" 75) 85) 85) (defineLocal \"compute_86\" (second (getLocal \"compute_85\" 85) 86) 86) (defineLocal \"compute_87\" (second (getLocal \"compute_86\" 86) 87) 87) (defineLocal \"compute_88\" (second (getLocal \"compute_87\" 87) 88) 88) (defineLocal \"compute_89\" (second (getLocal \"compute_88\" 88) 89) 89) (defineLocal \"compute_93\" (first (getLocal \"compute_87\" 87) 93) 93) (defineLocal \"compute_94\" (first (getLocal \"compute_88\" 88) 94) 94) (defineLocal \"compute_95\" (first (getLocal \"compute_89\" 89) 95) 95) (defineLocal \"compute_96\" (second (getLocal \"compute_89\" 89) 96) 96) (set (attr (attr (data) \"prices\" 100) \"last\" 100) (add (attr (attr (data) \"prices\" 100) \"last\" 100) (literal (intOrNat 1) 100) 100) 100) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (add (attr (attr (data) \"prices\" 100) \"sum\" 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) 100) (set (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"last\" 100) 100) (mul (truediv (add (add (getLocal \"compute_93\" 93) (getLocal \"compute_94\" 94) 97) (getLocal \"compute_95\" 95) 97) (literal (intOrNat 3) 97) 97) (getLocal \"compute_96\" 96) 97) 100) (set (attr (attr (data) \"volumes\" 101) \"last\" 101) (add (attr (attr (data) \"volumes\" 101) \"last\" 101) (literal (intOrNat 1) 101) 101) 101) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (add (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getLocal \"compute_96\" 96) 101) 101) (set (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"last\" 101) 101) (getLocal \"compute_96\" 96) 101) (ifBlock (gt (add (sub (attr (attr (data) \"prices\" 100) \"last\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 104) (literal (intOrNat 1) 104) 104) (attr (data) \"numDataPoints\" 104) 104) ((verify (lt (attr (attr (data) \"prices\" 100) \"first\" 104) (attr (attr (data) \"prices\" 100) \"last\" 100) 105) False 105) (set (attr (attr (data) \"prices\" 100) \"sum\" 100) (openVariant (isNat (sub (attr (attr (data) \"prices\" 100) \"sum\" 100) (getItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) 105) 105) \"Some\" 105) 105) (delItem (attr (attr (data) \"prices\" 100) \"saved\" 100) (attr (attr (data) \"prices\" 100) \"first\" 104) 105) (set (attr (attr (data) \"prices\" 100) \"first\" 104) (add (attr (attr (data) \"prices\" 100) \"first\" 104) (literal (intOrNat 1) 105) 105) 105) (verify (lt (attr (attr (data) \"volumes\" 101) \"first\" 106) (attr (attr (data) \"volumes\" 101) \"last\" 101) 106) False 106) (set (attr (attr (data) \"volumes\" 101) \"sum\" 101) (openVariant (isNat (sub (attr (attr (data) \"volumes\" 101) \"sum\" 101) (getItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) 106) 106) \"Some\" 106) 106) (delItem (attr (attr (data) \"volumes\" 101) \"saved\" 101) (attr (attr (data) \"volumes\" 101) \"first\" 106) 106) (set (attr (attr (data) \"volumes\" 101) \"first\" 106) (add (attr (attr (data) \"volumes\" 101) \"first\" 106) (literal (intOrNat 1) 106) 106) 106)) 104) (set (attr (data) \"computedPrice\" 121) (truediv (attr (attr (data) \"prices\" 100) \"sum\" 100) (attr (attr (data) \"volumes\" 101) \"sum\" 101) 109) 109))))\nflags ()\nglobals ()\nstorage_layout ()\nentry_points_layout ())", "line_no": 386, "show": true, "accept_unknown_types": false}, {"action": "html", "tag": "h2", "inner": "WHEN three updates are provided", "line_no": 388}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 404) (tuple (literal (timestamp 1595104530) 396) (tuple (literal (timestamp 1595104531) 397) (tuple (literal (intOrNat 3059701) 404) (tuple (literal (intOrNat 1) 404) (tuple (literal (intOrNat 2) 404) (tuple (literal (intOrNat 3) 404) (literal (intOrNat 4) 404) 404) 404) 404) 404) 404) 404))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 402, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 421) (tuple (literal (timestamp 1595104532) 413) (tuple (literal (timestamp 1595104533) 414) (tuple (literal (intOrNat 3059701) 421) (tuple (literal (intOrNat 5) 421) (tuple (literal (intOrNat 6) 421) (tuple (literal (intOrNat 7) 421) (literal (intOrNat 8) 421) 421) 421) 421) 421) 421) 421))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 419, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "message", "id": 0, "message": "update", "params": "(type_annotation (big_map 488 ((literal (string \"XTZ-USD\") 438) (tuple (literal (timestamp 1595104534) 430) (tuple (literal (timestamp 1595104535) 431) (tuple (literal (intOrNat 3059701) 438) (tuple (literal (intOrNat 9) 438) (tuple (literal (intOrNat 10) 438) (tuple (literal (intOrNat 11) 438) (literal (intOrNat 12) 438) 438) 438) 438) 438) 438) 438))) (bigmap \"string\" (pair \"timestamp\" (pair \"timestamp\" (pair \"nat\" (pair \"nat\" (pair \"nat\" (pair \"nat\" \"nat\"))))))) 488)", "line_no": 436, "title": "", "messageClass": "", "source": "none", "sender": "address:(literal (address \"KT1QLPABNCD4z1cSYVv3ntYDYgtWTed7LkYr\") 467)", "chain_id": "", "time": 0, "amount": "(literal (mutez 0) 1)", "show": true, "valid": true}, {"action": "html", "tag": "h2", "inner": "THEN the contract is only tracking two updates", "line_no": 440}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (contractData 0 438) \"prices\" 441) \"last\" 441) (attr (attr (contractData 0 438) \"prices\" 441) \"first\" 441) 441) (literal (intOrNat 1) 441) 441) (literal (intOrNat 2) 441) 441)", "line_no": 441}, {"action": "verify", "condition": "(eq (add (sub (attr (attr (contractData 0 438) \"volumes\" 442) \"last\" 442) (attr (attr (contractData 0 438) \"volumes\" 442) \"first\" 442) 442) (literal (intOrNat 1) 442) 442) (literal (intOrNat 2) 442) 442)", "line_no": 442}, {"action": "html", "tag": "h2", "inner": "AND the computed price is the VWAP of the latter two updates", "line_no": 444}, {"action": "verify", "condition": "(eq (attr (contractData 0 438) \"computedPrice\" 458) (literal (intOrNat 8) 458) 458)", "line_no": 458}]}]